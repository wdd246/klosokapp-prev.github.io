<html lang="pl" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>K≈Çosok ‚Äì System Dyspozytora v2.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,400&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ‚îÄ‚îÄ VARIABLES ‚îÄ‚îÄ */
:root {
  --sw:250px; --sc:65px; --th:57px;
  --primary:#007bff; --success:#28a745; --warning:#ffc107; --danger:#dc3545;
  --info:#17a2b8; --secondary:#6c757d; --purple:#6f42c1; --teal:#20c997;
  /* Light defaults */
  --sb:#343a40; --st:#c2c7d0; --sab:rgba(255,255,255,.1); --shb:rgba(255,255,255,.08); --sbd:rgba(255,255,255,.1);
  --tb:#fff; --tbd:#dee2e6; --tt:#495057;
  --cb:#f4f6f9; --cd:#fff; --cs:0 0 1px rgba(0,0,0,.125),0 1px 3px rgba(0,0,0,.2); --cbo:#dee2e6;
  --tp:#212529; --tm:#6c757d; --bc:#dee2e6;
  --ib:#fff; --ibd:#ced4da; --it:#495057;
  --ts:rgba(0,0,0,.025); --th2:rgba(0,0,0,.04);
  --ob:rgba(0,0,0,.55); --db:#fff; --dbd:rgba(0,0,0,.15); --dh:#f8f9fa;
}
[data-theme=dark] {
  --sb:#1f2533; --st:#9ba3af; --sab:rgba(0,123,255,.2); --shb:rgba(255,255,255,.05); --sbd:rgba(255,255,255,.07);
  --tb:#252d3d; --tbd:#303847; --tt:#c2c7d0;
  --cb:#1a2033; --cd:#252d3d; --cs:0 0 1px rgba(0,0,0,.4),0 1px 3px rgba(0,0,0,.5); --cbo:#303847;
  --tp:#c2c7d0; --tm:#6c757d; --bc:#303847;
  --ib:#1e2637; --ibd:#303847; --it:#c2c7d0;
  --ts:rgba(255,255,255,.03); --th2:rgba(255,255,255,.05);
  --ob:rgba(0,0,0,.75); --db:#252d3d; --dbd:#303847; --dh:#1a2033;
}

/* ‚îÄ‚îÄ RESET ‚îÄ‚îÄ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px}
body{font-family:'Lato','Roboto',sans-serif;background:var(--cb);color:var(--tp);transition:background .3s,color .3s;overflow-x:hidden}
a{text-decoration:none;color:var(--primary)}
ul{list-style:none}
input,select,textarea,button{font-family:inherit}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.wrapper{display:flex;min-height:100vh}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:var(--sw);background:var(--sb);flex-shrink:0;display:flex;flex-direction:column;
  position:fixed;top:0;left:0;bottom:0;z-index:1040;transition:width .3s,transform .3s;overflow:hidden}
.sidebar.col{width:var(--sc)}
.sbrand{display:flex;align-items:center;gap:11px;padding:13px 15px;
  background:rgba(0,123,255,.15);border-bottom:1px solid var(--sbd);min-height:var(--th);flex-shrink:0}
.blogo{width:31px;height:31px;border-radius:7px;background:linear-gradient(135deg,#007bff,#0056b3);
  display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.btxt{font-size:1.1rem;font-weight:900;color:#fff;letter-spacing:-.5px;white-space:nowrap}
.bsub{font-size:.61rem;color:var(--st);white-space:nowrap}
.sidebar.col .btxt,.sidebar.col .bsub,.sidebar.col .nlb,.sidebar.col .nbadge,.sidebar.col .mhdr{display:none}
.sidebar.col .sbrand{justify-content:center;padding:13px 0}
.snav{flex:1;overflow-y:auto;overflow-x:hidden;padding:5px 0}
.snav::-webkit-scrollbar{width:3px}
.snav::-webkit-scrollbar-thumb{background:var(--sbd);border-radius:2px}
.mhdr{padding:9px 15px 3px;font-size:.63rem;font-weight:700;color:var(--st);opacity:.6;
  text-transform:uppercase;letter-spacing:.1em;white-space:nowrap}
.ni{display:flex;align-items:center;gap:9px;padding:9px 15px;cursor:pointer;
  color:var(--st);font-size:.875rem;font-weight:400;
  border-left:3px solid transparent;transition:all .15s;white-space:nowrap;position:relative}
.ni:hover{background:var(--shb);color:#fff}
.ni.active{background:var(--sab);color:#fff;border-left-color:var(--primary);font-weight:600}
.nic{width:19px;text-align:center;font-size:.93rem;flex-shrink:0}
.nlb{flex:1}
.nbadge{background:var(--danger);color:#fff;font-size:.59rem;font-weight:700;
  padding:2px 6px;border-radius:10px;min-width:17px;text-align:center}
.nbadge.b{background:var(--primary)}
.sidebar.col .ni{justify-content:center;padding:10px 0}
.sidebar.col .ni::after{content:attr(data-tip);position:absolute;left:calc(100% + 5px);
  background:#222;color:#fff;padding:3px 9px;border-radius:4px;font-size:.77rem;
  white-space:nowrap;opacity:0;pointer-events:none;transform:translateX(-4px);
  transition:all .15s;z-index:100}
.sidebar.col .ni:hover::after{opacity:1;transform:none}
.sfoot{padding:9px 15px;border-top:1px solid var(--sbd);font-size:.7rem;color:var(--st);flex-shrink:0}
.sidebar.col .sfoot{padding:9px 0;text-align:center}
.sidebar.col .sfoot span{display:none}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.main{flex:1;margin-left:var(--sw);display:flex;flex-direction:column;min-height:100vh;transition:margin-left .3s}
.main.col{margin-left:var(--sc)}
.topbar{background:var(--tb);border-bottom:1px solid var(--tbd);height:var(--th);
  display:flex;align-items:center;padding:0 16px;gap:8px;
  position:sticky;top:0;z-index:1030;flex-shrink:0;transition:background .3s,border-color .3s}
.tbtog{background:none;border:none;cursor:pointer;color:var(--tt);font-size:1.1rem;
  padding:4px 7px;border-radius:4px;transition:background .15s}
.tbtog:hover{background:rgba(0,0,0,.07)}
.tbtitle{font-size:.9rem;font-weight:700;color:var(--tt)}
.sp{flex:1}
.tbbtn{background:none;border:none;cursor:pointer;color:var(--tt);font-size:.92rem;
  padding:5px 8px;border-radius:4px;transition:background .15s;display:flex;align-items:center;gap:5px}
.tbbtn:hover{background:rgba(0,0,0,.07)}
.umenu{position:relative}
.ubtn{display:flex;align-items:center;gap:7px;background:none;border:none;cursor:pointer;
  padding:4px 7px;border-radius:4px;color:var(--tt);transition:background .15s}
.ubtn:hover{background:rgba(0,0,0,.07)}
.uav{width:29px;height:29px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:.7rem;font-weight:700;color:#fff}
.uname{font-size:.82rem;font-weight:600;color:var(--tt)}
.urole{font-size:.62rem;color:var(--tm)}
.udrop{position:absolute;top:calc(100% + 7px);right:0;background:var(--db);
  border:1px solid var(--dbd);border-radius:6px;min-width:172px;
  box-shadow:0 4px 20px rgba(0,0,0,.2);display:none;z-index:2000}
.udrop.show{display:block;animation:dropIn .15s ease}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
.ditem{display:flex;align-items:center;gap:9px;padding:9px 13px;cursor:pointer;
  font-size:.82rem;color:var(--tp);transition:background .12s}
.ditem:first-child{border-radius:6px 6px 0 0}
.ditem:last-child{border-radius:0 0 6px 6px}
.ditem:hover{background:var(--dh)}
.ditem.dr{color:var(--danger)}
.ddiv{border-top:1px solid var(--dbd);margin:4px 0}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{flex:1;padding:16px}
.page{display:none}
.page.active{display:block;animation:pf .2s ease}
@keyframes pf{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:none}}
.ph{margin-bottom:16px}
.ph h1{font-size:1.4rem;font-weight:900;font-family:'Lato',sans-serif;display:flex;align-items:center;gap:9px}
.bc{display:flex;align-items:center;gap:5px;font-size:.76rem;color:var(--tm);margin-top:3px}
.bcs{opacity:.5}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--cd);border:1px solid var(--cbo);border-radius:6px;
  box-shadow:var(--cs);transition:background .3s,border-color .3s;margin-bottom:16px}
.ch{display:flex;align-items:center;justify-content:space-between;
  padding:10px 15px;border-bottom:1px solid var(--cbo);flex-wrap:wrap;gap:7px}
.ct{font-size:.83rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;
  color:var(--tp);display:flex;align-items:center;gap:7px}
.ct i{color:var(--tm)}
.ctools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.cb{padding:13px 15px}
.p0{padding:0!important}

/* ‚îÄ‚îÄ INFO-BOX ‚îÄ‚îÄ */
.ibox{background:var(--cd);border:1px solid var(--cbo);border-radius:6px;
  box-shadow:var(--cs);display:flex;align-items:stretch;overflow:hidden;
  margin-bottom:16px;min-height:75px;transition:background .3s}
.iic{width:66px;display:flex;align-items:center;justify-content:center;
  font-size:1.7rem;color:#fff;flex-shrink:0}
.bg-b{background:var(--primary)} .bg-g{background:var(--success)} .bg-a{background:var(--warning)}
.bg-r{background:var(--danger)} .bg-i{background:var(--info)} .bg-p{background:var(--purple)}
.bg-t{background:var(--teal)}
.ixc{padding:9px 11px;flex:1}
.ixt{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--tm)}
.ixn{font-size:1.7rem;font-weight:900;font-family:'Lato',sans-serif;color:var(--tp);line-height:1}
.ixs{font-size:.68rem;color:var(--tm);margin-top:2px}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.row{display:flex;flex-wrap:wrap;margin:0 -8px}
.col{padding:0 8px;flex:1;min-width:0}
.c3{flex:0 0 25%;max-width:25%;padding:0 8px}
.c4{flex:0 0 33.333%;max-width:33.333%;padding:0 8px}
.c6{flex:0 0 50%;max-width:50%;padding:0 8px}
.c8{flex:0 0 66.667%;max-width:66.667%;padding:0 8px}
.c12{flex:0 0 100%;max-width:100%;padding:0 8px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;
  border-radius:4px;border:1px solid transparent;cursor:pointer;
  font-family:inherit;font-size:.82rem;font-weight:500;
  transition:all .15s;line-height:1.4;white-space:nowrap}
.btn-xs{padding:2px 7px;font-size:.71rem} .btn-sm{padding:4px 10px;font-size:.78rem}
.btn-lg{padding:9px 18px;font-size:.97rem} .btn-bl{width:100%;justify-content:center}
.btn-pr{background:var(--primary);border-color:#0062cc;color:#fff} .btn-pr:hover{background:#0062cc}
.btn-su{background:var(--success);border-color:#1e7e34;color:#fff} .btn-su:hover{background:#1e7e34}
.btn-wa{background:var(--warning);border-color:#e0a800;color:#212529} .btn-wa:hover{background:#e0a800}
.btn-da{background:var(--danger);border-color:#bd2130;color:#fff} .btn-da:hover{background:#bd2130}
.btn-in{background:var(--info);border-color:#117a8b;color:#fff} .btn-in:hover{background:#117a8b}
.btn-sc{background:var(--secondary);border-color:#545b62;color:#fff} .btn-sc:hover{background:#545b62}
.btn-op{background:transparent;border-color:var(--primary);color:var(--primary)} .btn-op:hover{background:var(--primary);color:#fff}
.btn-os{background:transparent;border-color:var(--bc);color:var(--tm)} .btn-os:hover{background:rgba(0,0,0,.05)}
.btn-fl{background:transparent;border-color:transparent} .btn-fl:hover{background:rgba(0,0,0,.05)}
.btn-ic{padding:4px 7px}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-block;padding:2px 7px;border-radius:3px;font-size:.68rem;font-weight:700;line-height:1}
.ba-pr{background:var(--primary);color:#fff} .ba-su{background:var(--success);color:#fff}
.ba-wa{background:var(--warning);color:#212529} .ba-da{background:var(--danger);color:#fff}
.ba-in{background:var(--info);color:#fff} .ba-sc{background:var(--secondary);color:#fff}
.ba-pu{background:var(--purple);color:#fff} .ba-pi{border-radius:20px}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tbl{width:100%;border-collapse:collapse;font-size:.82rem;color:var(--tp)}
.tbl th{padding:8px 10px;text-align:left;font-size:.7rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.05em;border-bottom:2px solid var(--bc);
  color:var(--tm);white-space:nowrap}
.tbl td{padding:8px 10px;border-bottom:1px solid var(--bc);vertical-align:middle}
.tbl-str tbody tr:nth-child(even) td{background:var(--ts)}
.tbl-hov tbody tr:hover td{background:var(--th2)}
.tbl tbody tr:last-child td{border-bottom:none}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.fg{margin-bottom:12px}
.fl{display:block;margin-bottom:4px;font-size:.78rem;font-weight:600;color:var(--tp)}
.fc{width:100%;padding:6px 10px;background:var(--ib);border:1px solid var(--ibd);
  border-radius:4px;color:var(--it);font-size:.82rem;
  transition:border-color .15s,box-shadow .15s;outline:none}
.fc:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(0,123,255,.25)}
.fc option{background:var(--ib)}
textarea.fc{resize:vertical}
.fr{display:grid;gap:10px}
.fr2{grid-template-columns:1fr 1fr} .fr3{grid-template-columns:1fr 1fr 1fr}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mov{position:fixed;inset:0;background:var(--ob);z-index:2000;
  display:flex;align-items:center;justify-content:center;
  padding:16px;backdrop-filter:blur(3px);animation:ovi .15s ease}
@keyframes ovi{from{opacity:0}to{opacity:1}}
.md{background:var(--cd);border:1px solid var(--cbo);border-radius:8px;
  box-shadow:0 10px 40px rgba(0,0,0,.4);width:100%;max-width:510px;
  max-height:90vh;overflow-y:auto;animation:mdi .18s ease}
.md.lg{max-width:690px}
@keyframes mdi{from{opacity:0;transform:scale(.95)translateY(-10px)}to{opacity:1;transform:none}}
.md::-webkit-scrollbar{width:4px}
.md::-webkit-scrollbar-thumb{background:var(--bc)}
.mhd{display:flex;align-items:center;justify-content:space-between;padding:13px 17px;border-bottom:1px solid var(--cbo)}
.mti{font-size:.94rem;font-weight:700;font-family:'Lato',sans-serif}
.mcl{background:none;border:none;cursor:pointer;font-size:1.1rem;color:var(--tm);padding:3px;border-radius:4px;transition:color .15s}
.mcl:hover{color:var(--danger)}
.mbd{padding:16px 17px}
.mft{padding:11px 17px;border-top:1px solid var(--cbo);display:flex;justify-content:flex-end;gap:7px}

/* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
.toast-c{position:fixed;bottom:16px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px}
.toast{background:var(--cd);border:1px solid var(--cbo);border-radius:6px;
  padding:10px 13px;box-shadow:0 4px 20px rgba(0,0,0,.3);
  display:flex;align-items:center;gap:8px;font-size:.82rem;
  min-width:230px;max-width:350px;
  animation:tin .25s ease,tout .25s ease 2.8s forwards}
@keyframes tin{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:none}}
@keyframes tout{to{opacity:0;transform:translateX(20px)}}
.ti{font-size:.92rem;flex-shrink:0}
.toast.ok .ti{color:var(--success)} .toast.err .ti{color:var(--danger)}
.toast.inf .ti{color:var(--info)} .toast.wrn .ti{color:var(--warning)}

/* ‚îÄ‚îÄ ALERTS inline ‚îÄ‚îÄ */
.alert{padding:8px 12px;border-radius:4px;font-size:.82rem;margin-bottom:10px;border-left:4px solid}
.al-d{background:rgba(220,53,69,.1);border-color:var(--danger);color:#dc3545}
.al-s{background:rgba(40,167,69,.1);border-color:var(--success);color:#28a745}
.al-w{background:rgba(255,193,7,.1);border-color:var(--warning);color:#856404}
.al-i{background:rgba(23,162,184,.1);border-color:var(--info);color:#0c5460}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.lpg{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#1a2033 0%,#252d3d 50%,#1a2033 100%);padding:16px}
[data-theme=light] .lpg{background:linear-gradient(135deg,#e9ecef,#f8f9fa,#e9ecef)}
.lbox{width:100%;max-width:385px;background:var(--cd);border:1px solid var(--cbo);
  border-radius:10px;box-shadow:0 10px 50px rgba(0,0,0,.4);overflow:hidden}
.lhd{background:linear-gradient(135deg,#007bff,#0056b3);padding:26px 20px;text-align:center}
.llo{font-size:2.2rem;margin-bottom:6px}
.lti{font-size:1.3rem;font-weight:900;color:#fff;font-family:'Lato',sans-serif}
.lsu{font-size:.75rem;color:rgba(255,255,255,.7);margin-top:3px}
.lbd{padding:22px 20px}
.lft{padding:11px 20px;background:rgba(0,0,0,.05);text-align:center;font-size:.72rem;color:var(--tm)}
.rlink{text-align:center;margin-top:11px;font-size:.79rem;color:var(--tm)}
.rlink a{color:var(--primary);font-weight:600}

/* ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ */
.tlwrap{overflow-x:auto;padding-bottom:6px}
.tlg{min-width:840px}
.tlh{display:flex;margin-bottom:5px}
.tlyl{width:162px;flex-shrink:0}
.tlhs{flex:1;display:flex;justify-content:space-between;padding-right:6px}
.tlhl{font-size:.62rem;color:var(--tm);font-family:'Courier New',monospace}
.tlrow{display:flex;align-items:center;margin-bottom:6px}
.tlyn{width:162px;flex-shrink:0;padding-right:7px;font-size:.76rem;font-weight:600}
.tlys{font-size:.65rem;color:var(--tm);font-weight:400}
.tlbar{flex:1;height:33px;background:rgba(0,0,0,.04);border-radius:4px;position:relative;overflow:visible}
[data-theme=dark] .tlbar{background:rgba(255,255,255,.04)}
.tlseg{position:absolute;height:100%;border-radius:3px;display:flex;align-items:center;
  justify-content:center;font-size:.58rem;font-weight:700;color:#fff;
  cursor:pointer;overflow:hidden;transition:filter .12s;min-width:2px}
.tlseg:hover{filter:brightness(1.25);z-index:5}
.tlsl{padding:0 3px;white-space:nowrap;overflow:hidden;pointer-events:none}
.tsd{background:linear-gradient(90deg,#007bff,#4dabf7)}
.tsr{background:linear-gradient(90deg,#fd7e14,#ffa94d)}
.tsl2{background:linear-gradient(90deg,#28a745,#51cf66)}
.tst{background:linear-gradient(90deg,#6c757d,#adb5bd)}
.tsterm{background:linear-gradient(90deg,#6f42c1,#a855f7)}
.tlleg{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px}
.tllen{display:flex;align-items:center;gap:4px;font-size:.7rem;color:var(--tm)}
.tllb{width:13px;height:7px;border-radius:2px}

/* ‚îÄ‚îÄ POINTS BARS ‚îÄ‚îÄ */
.pbrow{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:4px;margin-bottom:5px;transition:background .12s}
.pbrow:hover{background:var(--th2)}
.pbrank{width:22px;font-weight:700;text-align:center;font-size:.88rem}
.pbname{width:130px;flex-shrink:0;font-weight:500;font-size:.81rem}
.pbbars{flex:1;display:flex;gap:2px;height:17px;border-radius:3px;overflow:hidden}
.pbpos{background:var(--primary);display:flex;align-items:center;justify-content:center;
  font-size:.58rem;font-weight:700;color:#fff;min-width:0}
.pbneg{background:var(--danger);display:flex;align-items:center;justify-content:center;
  font-size:.58rem;font-weight:700;color:#fff;min-width:0}
.pbnet{min-width:42px;text-align:right;font-family:'Courier New',monospace;font-size:.83rem;font-weight:700}

/* ‚îÄ‚îÄ FUEL BAR ‚îÄ‚îÄ */
.fpbar{height:7px;background:var(--bc);border-radius:4px;overflow:hidden;margin:3px 0}
.fpfill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--primary),var(--info));transition:width 1s ease}

/* ‚îÄ‚îÄ VEHICLE CARDS ‚îÄ‚îÄ */
.vcard{background:var(--cd);border:1px solid var(--cbo);border-radius:6px;
  box-shadow:var(--cs);overflow:hidden;transition:transform .2s,box-shadow .2s;margin-bottom:16px}
.vcard:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.2)}
.vch{padding:13px 14px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--cbo)}
.vic{width:40px;height:40px;border-radius:7px;background:linear-gradient(135deg,#007bff,#0056b3);
  display:flex;align-items:center;justify-content:center;font-size:1.25rem;color:#fff}
.vreg{font-size:.97rem;font-weight:700}
.vmod{font-size:.73rem;color:var(--tm)}
.vcb{padding:13px 14px}
.vst{display:flex;justify-content:space-between;align-items:center;
  padding:3px 0;font-size:.79rem;border-bottom:1px solid var(--ts)}
.vst:last-child{border-bottom:none}
.vsl{color:var(--tm)} .vsv{font-weight:600}
.vcf{padding:9px 14px;border-top:1px solid var(--cbo);display:flex;gap:5px}

/* ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ */
.rcard{display:flex;align-items:center;gap:9px;padding:9px;border-radius:6px;
  margin-bottom:7px;background:var(--ts)}
.rnum{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:.77rem;font-weight:700;color:#fff}
.r1 .rnum{background:#ffd700;color:#333} .r2 .rnum{background:#c0c0c0;color:#333}
.r3 .rnum{background:#cd7f32} .rn .rnum{background:var(--secondary)}
.rinfo{flex:1}
.rname{font-weight:600;font-size:.86rem}
.rsub{font-size:.7rem;color:var(--tm)}
.rscore{font-weight:700;font-size:.97rem}
.rscore.pos{color:var(--success)} .rscore.neg{color:var(--danger)}

/* ‚îÄ‚îÄ DRIVER AVATAR ‚îÄ‚îÄ */
.dav{width:26px;height:26px;border-radius:5px;display:flex;align-items:center;
  justify-content:center;font-size:.65rem;font-weight:700;color:#fff;flex-shrink:0}
.dcell{display:flex;align-items:center;gap:7px}

/* ‚îÄ‚îÄ SQL ‚îÄ‚îÄ */
.sqltxt{width:100%;height:140px;resize:vertical;font-family:'Courier New',monospace;
  font-size:.83rem;background:#1a2033;color:#c2c7d0;
  border:1px solid var(--bc);border-radius:4px;padding:9px}
.sqlres{margin-top:12px;overflow-x:auto}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
.ts{color:var(--success)!important} .td{color:var(--danger)!important}
.tp2{color:var(--primary)!important} .tw{color:var(--warning)!important} .tm2{color:var(--tm)!important}
.tr2{text-align:right} .tc{text-align:center}
.mono{font-family:'Courier New',monospace}
.fw7{font-weight:700} .df{display:flex} .ac{align-items:center}
.g2{gap:8px} .g3{gap:12px} .mb0{margin-bottom:0} .mt2{margin-top:8px} .mt3{margin-top:12px}
.w100{width:100%}
.empty{text-align:center;padding:36px 16px;color:var(--tm)}
.empty i{font-size:2.3rem;margin-bottom:9px;display:block}
.sep{border:none;border-top:1px solid var(--bc);margin:11px 0}
.tip{position:fixed;background:#212529;color:#fff;border-radius:4px;
  padding:5px 10px;font-size:.73rem;z-index:9000;pointer-events:none;
  white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,.4)}

/* ‚îÄ‚îÄ RWD ‚îÄ‚îÄ */
@media(max-width:992px){.c3,.c4{flex:0 0 50%;max-width:50%} .c8{flex:0 0 100%;max-width:100%}}
@media(max-width:768px){
  .col,.c3,.c4,.c6,.c8,.c12{flex:0 0 100%;max-width:100%}
  .main{margin-left:0!important}
  .sidebar{transform:translateX(-100%)}
  .sidebar.mopen{transform:none;width:var(--sw)!important}
  .sovl{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1035;display:none}
  .sovl.show{display:block}
  .content{padding:12px}
  .fr2,.fr3{grid-template-columns:1fr}
  .uname,.tbtitle{display:none}
}
@media(max-width:480px){.ibox{flex-direction:column} .iic{width:100%;height:38px}}
</style>
</head>
<body>

<div class="sovl" id="sovl" onclick="closeMob()"></div>
<div class="toast-c" id="toastC"></div>
<div class="tip" id="tlTip" style="display:none"></div>

<!-- LOGIN -->
<div id="loginPg" class="lpg">
  <div class="lbox">
    <div class="lhd">
      <div class="llo">üöå</div>
      <div class="lti">K≈Çosok</div>
      <div class="lsu">System ZarzƒÖdzania Dyspozytorem v2.0</div>
    </div>
    <div class="lbd">
      <div id="loginView">
        <div id="lAlert"></div>
        <div class="fg"><label class="fl"><i class="fas fa-user"></i> Login lub email</label>
          <input type="text" class="fc" id="lUser" placeholder="admin" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <div class="fg"><label class="fl"><i class="fas fa-lock"></i> Has≈Ço</label>
          <input type="password" class="fc" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <button class="btn btn-pr btn-bl btn-lg" onclick="doLogin()"><i class="fas fa-sign-in-alt"></i> Zaloguj siƒô</button>
        <div class="rlink">Brak konta? <a href="#" onclick="showReg()">Zarejestruj siƒô</a></div>
        <hr class="sep">
        <div style="font-size:.73rem;color:var(--tm);text-align:center;line-height:1.9">
          <strong>admin</strong> / admin123 &nbsp;|&nbsp; <strong>dyspozytor</strong> / disp123 &nbsp;|&nbsp; <strong>kowalski</strong> / driver123
        </div>
      </div>
      <div id="regView" style="display:none">
        <div id="rAlert"></div>
        <div class="fr fr2">
          <div class="fg"><label class="fl">Imiƒô</label><input type="text" class="fc" id="rFn" placeholder="Jan"></div>
          <div class="fg"><label class="fl">Nazwisko</label><input type="text" class="fc" id="rLn" placeholder="Kowalski"></div>
        </div>
        <div class="fg"><label class="fl">Login *</label><input type="text" class="fc" id="rUn" placeholder="jan.k"></div>
        <div class="fg"><label class="fl">Email *</label><input type="email" class="fc" id="rEm"></div>
        <div class="fg"><label class="fl">Has≈Ço * (min. 6 znak√≥w)</label><input type="password" class="fc" id="rPw"></div>
        <div class="fg"><label class="fl">Rola</label>
          <select class="fc" id="rRole" onchange="toggleInvite()">
            <option value="dispatcher">Dyspozytor</option>
            <option value="driver">Kierowca</option>
            <option value="admin">Admin (kod wymagany)</option>
          </select></div>
        <div class="fg" id="invGrp" style="display:none"><label class="fl">Kod zaproszenia</label>
          <input type="text" class="fc" id="rInv" placeholder="KLOSOK-ADMIN-2025"></div>
        <button class="btn btn-su btn-bl" onclick="doRegister()"><i class="fas fa-user-plus"></i> Zarejestruj siƒô</button>
        <div class="rlink">Masz konto? <a href="#" onclick="showLogin()">Zaloguj siƒô</a></div>
      </div>
    </div>
    <div class="lft">¬© 2025 K≈Çosok Transport Sp. z o.o.</div>
  </div>
</div>

<!-- APP -->
<div id="app" class="wrapper" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sbrand">
      <div class="blogo">üöå</div>
      <div><div class="btxt">K≈Çosok</div><div class="bsub">Transport System</div></div>
    </div>
    <nav class="snav" id="snav"></nav>
    <div class="sfoot"><i class="fas fa-circle ts" style="font-size:.58rem"></i><span> v2.0 ¬∑ online</span></div>
  </aside>

  <!-- MAIN -->
  <div class="main" id="main">
    <nav class="topbar">
      <button class="tbtog" onclick="toggleSB()"><i class="fas fa-bars"></i></button>
      <span class="tbtitle" id="tbTitle">Dashboard</span>
      <div class="sp"></div>
      <button class="tbbtn" onclick="toggleTheme()" id="thBtn" title="Zmie≈Ñ motyw"><i class="fas fa-moon"></i></button>
      <div class="umenu">
        <button class="ubtn" onclick="toggleUD()">
          <div class="uav" id="topAv">U</div>
          <div style="display:flex;flex-direction:column;align-items:flex-start">
            <span class="uname" id="topName">‚Äî</span>
            <span class="urole" id="topRole">‚Äî</span>
          </div>
          <i class="fas fa-chevron-down" style="font-size:.65rem;margin-left:2px"></i>
        </button>
        <div class="udrop" id="udrop">
          <div class="ditem" onclick="showProfile()"><i class="fas fa-user-cog"></i> Profil & Has≈Ço</div>
          <div class="ditem" onclick="showPage('settings')"><i class="fas fa-cog"></i> Ustawienia</div>
          <div class="ddiv"></div>
          <div class="ditem dr" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Wyloguj siƒô</div>
        </div>
      </div>
    </nav>

    <div class="content" id="contentArea">

      <!-- DASHBOARD -->
      <div class="page" id="pg-dashboard">
        <div class="ph"><h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Dashboard</span></div></div>
        <div class="row" id="dStats"></div>
        <div class="row">
          <div class="c8"><div id="dSched"></div></div>
          <div class="c4"><div id="dRank"></div></div>
        </div>
        <div id="dAlerts"></div>
      </div>

      <!-- DRIVERS -->
      <div class="page" id="pg-drivers">
        <div class="ph"><h1><i class="fas fa-id-card"></i> Kierowcy</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Kierowcy</span></div></div>
        <div class="card">
          <div class="ch"><div class="ct"><i class="fas fa-list"></i> Lista kierowc√≥w</div>
            <div class="ctools">
              <select class="fc" style="width:130px" id="drvSF" onchange="renderDrivers()">
                <option value="">Wszyscy</option>
                <option value="active" selected>Aktywni</option>
                <option value="inactive">Nieaktywni</option>
                <option value="vacation">Urlop</option>
                <option value="sick">Choroba</option>
              </select>
              <input class="fc" style="width:150px" id="drvSrch" placeholder="üîç Szukaj‚Ä¶" oninput="renderDrivers()">
              <button class="btn btn-pr btn-sm" onclick="openDrvForm()" id="btnAddDrv"><i class="fas fa-plus"></i> Dodaj</button>
            </div>
          </div>
          <div class="cb p0"><div style="overflow-x:auto">
            <table class="tbl tbl-hov tbl-str">
              <thead><tr><th>Kierowca</th><th>Nr prawa jazdy</th><th>Telefon</th><th>Zatrudniony</th><th>Status</th><th>Pkt netto (mies.)</th><th>Akcje</th></tr></thead>
              <tbody id="drvTb"></tbody>
            </table>
            <div class="empty" id="drvEmpty" style="display:none"><i class="fas fa-users-slash"></i>Brak kierowc√≥w</div>
          </div></div>
        </div>
      </div>

      <!-- VEHICLES -->
      <div class="page" id="pg-vehicles">
        <div class="ph"><h1><i class="fas fa-bus"></i> Pojazdy</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Pojazdy</span></div></div>
        <div class="card">
          <div class="ch"><div class="ct"><i class="fas fa-bus-alt"></i> Flota pojazd√≥w</div>
            <div class="ctools">
              <select class="fc" style="width:130px" id="vehSF" onchange="renderVehicles()">
                <option value="">Wszystkie</option><option value="active">Aktywne</option>
                <option value="maintenance">Serwis</option><option value="inactive">Nieaktywne</option>
              </select>
              <button class="btn btn-pr btn-sm" onclick="openVehForm()" id="btnAddVeh"><i class="fas fa-plus"></i> Dodaj pojazd</button>
            </div>
          </div>
          <div class="cb">
            <div class="row" id="vehGrid"></div>
            <div class="empty" id="vehEmpty" style="display:none"><i class="fas fa-bus"></i>Brak pojazd√≥w</div>
          </div>
        </div>
        <div class="card" id="vehAlerts" style="display:none">
          <div class="ch"><div class="ct"><i class="fas fa-exclamation-triangle tw"></i> Zbli≈ºajƒÖce siƒô przeglƒÖdy / ubezpieczenia</div></div>
          <div class="cb p0"><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Pojazd</th><th>PrzeglƒÖd</th><th>Ubezpieczenie</th></tr></thead><tbody id="vehAlertTb"></tbody></table></div></div>
        </div>
      </div>

      <!-- LINES -->
      <div class="page" id="pg-lines">
        <div class="ph"><h1><i class="fas fa-route"></i> Linie</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Linie</span></div></div>
        <div class="card">
          <div class="ch"><div class="ct"><i class="fas fa-map-marked-alt"></i> Linie komunikacyjne</div>
            <button class="btn btn-pr btn-sm" onclick="openLineForm()" id="btnAddLine"><i class="fas fa-plus"></i> Dodaj liniƒô</button>
          </div>
          <div class="cb p0"><div style="overflow-x:auto">
            <table class="tbl tbl-hov">
              <thead><tr><th>Nr</th><th>Nazwa</th><th>SkƒÖd</th><th>DokƒÖd</th><th>Dystans</th><th>Czas</th><th>Akcje</th></tr></thead>
              <tbody id="linesTb"></tbody>
            </table>
          </div></div>
        </div>
      </div>

      <!-- SCHEDULE -->
      <div class="page" id="pg-schedule">
        <div class="ph"><h1><i class="fas fa-calendar-alt"></i> Harmonogram</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Harmonogram</span></div></div>
        <div class="card" style="margin-bottom:13px">
          <div class="cb" style="padding:10px 14px">
            <div class="df g2" style="flex-wrap:wrap;align-items:flex-end">
              <div><label class="fl" style="margin-bottom:2px">Data</label>
                <input type="date" class="fc" id="schDate" onchange="renderSched()"></div>
              <div><label class="fl" style="margin-bottom:2px">Kierowca</label>
                <select class="fc" id="schDrvF" onchange="renderSched()"><option value="">Wszyscy</option></select></div>
              <div><label class="fl" style="margin-bottom:2px">Linia</label>
                <select class="fc" id="schLineF" onchange="renderSched()"><option value="">Wszystkie</option></select></div>
              <div style="margin-left:auto;display:flex;gap:5px">
                <button class="btn btn-pr btn-sm" onclick="openSchForm()" id="btnAddSch"><i class="fas fa-plus"></i> Kurs</button>
                <button class="btn btn-in btn-sm" onclick="openRangeForm()" id="btnRange"><i class="fas fa-calendar-week"></i> Zakres dat</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct"><i class="fas fa-clock"></i> O≈õ czasu ‚Äì linie / kierowcy</div></div>
          <div class="cb">
            <div class="tlwrap"><div class="tlg" id="tlGrid"></div></div>
            <div class="tlleg">
              <div class="tllen"><div class="tllb tsd"></div>Kurs</div>
              <div class="tllen"><div class="tllb tsr"></div>Przerwa</div>
              <div class="tllen"><div class="tllb tsl2"></div>Lunch</div>
              <div class="tllen"><div class="tllb tst"></div>Techniczna</div>
              <div class="tllen"><div class="tllb tsterm"></div>Terminal</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct"><i class="fas fa-list-alt"></i> Lista kurs√≥w</div></div>
          <div class="cb p0"><div style="overflow-x:auto">
            <table class="tbl tbl-hov">
              <thead><tr><th>Odjazd</th><th>Linia</th><th>Kierowca</th><th>Pojazd</th><th>Przyjazd</th><th>Status</th><th>Przerwy</th><th>Akcje</th></tr></thead>
              <tbody id="schTb"></tbody>
            </table>
            <div class="empty" id="schEmpty" style="display:none"><i class="fas fa-calendar-times"></i>Brak kurs√≥w</div>
          </div></div>
        </div>
      </div>

      <!-- POINTS -->
      <div class="page" id="pg-points">
        <div class="ph"><h1><i class="fas fa-star"></i> Punkty</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Punkty</span></div></div>
        <div class="row" id="ptStats"></div>
        <div class="row">
          <div class="c6">
            <div class="card">
              <div class="ch"><div class="ct"><i class="fas fa-trophy"></i> Ranking</div>
                <div class="ctools">
                  <select class="fc" style="width:90px" id="ptYr" onchange="renderPoints()"><option>2025</option><option>2024</option></select>
                  <select class="fc" style="width:105px" id="ptMo" onchange="renderPoints()">
                    <option value="">Ca≈Çy rok</option>
                    <option value="01">Stycze≈Ñ</option><option value="02">Luty</option><option value="03">Marzec</option>
                    <option value="04">Kwiecie≈Ñ</option><option value="05" selected>Maj</option><option value="06">Czerwiec</option>
                    <option value="07">Lipiec</option><option value="08">Sierpie≈Ñ</option><option value="09">Wrzesie≈Ñ</option>
                    <option value="10">Pa≈∫dziernik</option><option value="11">Listopad</option><option value="12">Grudzie≈Ñ</option>
                  </select>
                </div>
              </div>
              <div class="cb" id="ptRank"></div>
            </div>
          </div>
          <div class="c6">
            <div class="card">
              <div class="ch"><div class="ct"><i class="fas fa-list"></i> Wpisy</div>
                <div class="ctools">
                  <select class="fc" style="width:125px" id="ptFDrv" onchange="renderPtEntries()"><option value="">Wszyscy</option></select>
                  <select class="fc" style="width:105px" id="ptFTyp" onchange="renderPtEntries()">
                    <option value="">Wszystkie</option><option value="positive">‚úÖ Dodatnie</option><option value="negative">‚ùå Ujemne</option>
                  </select>
                  <button class="btn btn-pr btn-sm btn-ic" onclick="openPtForm()" id="btnAddPt"><i class="fas fa-plus"></i></button>
                </div>
              </div>
              <div class="cb p0" style="max-height:390px;overflow-y:auto" id="ptEntries"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- FUEL -->
      <div class="page" id="pg-fuel">
        <div class="ph"><h1><i class="fas fa-gas-pump"></i> Paliwo</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Paliwo</span></div></div>
        <div class="row">
          <div class="c6">
            <div class="card">
              <div class="ch"><div class="ct"><i class="fas fa-chart-bar"></i> Spalanie wg pojazdu</div>
                <div class="ctools">
                  <select class="fc" style="width:85px" id="fuYr" onchange="renderFuel()"><option>2025</option><option>2024</option></select>
                  <select class="fc" style="width:95px" id="fuMo" onchange="renderFuel()">
                    <option value="">Ca≈Çy rok</option><option value="05" selected>Maj</option>
                    <option value="04">Kwiecie≈Ñ</option><option value="03">Marzec</option>
                  </select>
                </div>
              </div>
              <div class="cb" id="fuSum"></div>
            </div>
          </div>
          <div class="c6">
            <div class="card">
              <div class="ch"><div class="ct"><i class="fas fa-user-clock"></i> Podzia≈Ç na kierowc√≥w</div>
                <div class="ctools">
                  <select class="fc" style="width:125px" id="bdBus" onchange="renderBD()"><option value="">Pojazd‚Ä¶</option></select>
                  <input type="date" class="fc" style="width:140px" id="bdDate" onchange="renderBD()">
                </div>
              </div>
              <div class="cb" id="fuBD"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="ch"><div class="ct"><i class="fas fa-database"></i> Rejestr tankowa≈Ñ</div>
            <button class="btn btn-pr btn-sm" onclick="openFuForm()" id="btnAddFu"><i class="fas fa-plus"></i> Dodaj</button>
          </div>
          <div class="cb p0"><div style="overflow-x:auto">
            <table class="tbl tbl-hov">
              <thead><tr><th>Data</th><th>Pojazd</th><th>Litry</th><th>km</th><th>L/100km</th><th>Koszt</th><th>Akcje</th></tr></thead>
              <tbody id="fuTb"></tbody>
            </table>
          </div></div>
        </div>
      </div>

      <!-- SUBSTITUTION -->
      <div class="page" id="pg-substitution">
        <div class="ph"><h1><i class="fas fa-exchange-alt"></i> Podstawianie kierowc√≥w</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Podstawianie</span></div></div>
        <div class="row" id="subStats"></div>
        <div class="row">
          <div class="c6">
            <div class="card">
              <div class="ch"><div class="ct"><i class="fas fa-medal"></i> Globalny ranking ‚Äì rekomendacja</div>
                <div class="ctools">
                  <select class="fc" style="width:90px" id="subYr" onchange="renderSub()"><option>2025</option></select>
                  <select class="fc" style="width:105px" id="subMo" onchange="renderSub()">
                    <option value="">Ca≈Çy rok</option><option value="05" selected>Maj</option>
                  </select>
                </div>
              </div>
              <div class="cb" id="subRank"></div>
            </div>
          </div>
          <div class="c6">
            <div class="card">
              <div class="ch"><div class="ct"><i class="fas fa-info-circle"></i> Metodologia oceny</div></div>
              <div class="cb">
                <p style="font-size:.82rem;color:var(--tm);line-height:1.6;margin-bottom:9px">Ranking ocenia kompleksowo ka≈ºdego kierowcƒô:</p>
                <table class="tbl tbl-str" style="font-size:.8rem">
                  <tbody>
                    <tr><td><i class="fas fa-star tw"></i> Punkty netto</td><td class="tr2 fw7">40%</td></tr>
                    <tr><td><i class="fas fa-gas-pump tp2"></i> Ekonomia paliwa</td><td class="tr2 fw7">25%</td></tr>
                    <tr><td><i class="fas fa-clock ts"></i> Punktualno≈õƒá</td><td class="tr2 fw7">20%</td></tr>
                    <tr><td><i class="fas fa-calendar-check tp2"></i> Dyspozycyjno≈õƒá</td><td class="tr2 fw7">15%</td></tr>
                  </tbody>
                </table>
                <div class="alert al-i mt3"><i class="fas fa-lightbulb"></i> Rekomenduj kierowc√≥w z <strong>TOP 3</strong> rankingu. Uwzglƒôdniaj tylko status <strong>Aktywny</strong>.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="page" id="pg-admin">
        <div class="ph"><h1><i class="fas fa-shield-alt"></i> Panel Administratora</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Admin</span></div></div>
        <div class="row" id="adminStats"></div>
        <div class="card">
          <div class="ch" style="padding:0">
            <div style="display:flex">
              <button class="btn btn-fl" id="atab-u" style="border-radius:0;border-bottom:2px solid var(--primary);font-weight:700" onclick="swAdminTab('u',this)">üë• U≈ºytkownicy</button>
              <button class="btn btn-fl" id="atab-s" onclick="swAdminTab('s',this)">üíæ SQL Console</button>
              <button class="btn btn-fl" id="atab-a" onclick="swAdminTab('a',this)">üìã Audit Log</button>
              <button class="btn btn-fl" id="atab-d" onclick="swAdminTab('d',this)">üóÑ Schema</button>
            </div>
          </div>
          <div id="atab-u-c" class="cb">
            <button class="btn btn-pr btn-sm" style="margin-bottom:11px" onclick="openUserForm()"><i class="fas fa-plus"></i> Nowy u≈ºytkownik</button>
            <div style="overflow-x:auto"><table class="tbl tbl-hov tbl-str">
              <thead><tr><th>ID</th><th>Login</th><th>Email</th><th>Rola</th><th>Imiƒô i nazwisko</th><th>Ostatnie logowanie</th><th>Aktywny</th><th>Akcje</th></tr></thead>
              <tbody id="usersTb"></tbody>
            </table></div>
          </div>
          <div id="atab-s-c" class="cb" style="display:none">
            <div class="alert al-w"><i class="fas fa-exclamation-triangle"></i> <strong>Uwaga!</strong> Ka≈ºde zapytanie jest logowane w audit logu. Zapytania modyfikujƒÖce dzia≈ÇajƒÖ na localStorage w trybie demo.</div>
            <div class="fg"><label class="fl">Zapytanie SQL</label>
              <textarea class="sqltxt" id="sqlQ" placeholder="SELECT * FROM drivers LIMIT 10;&#10;UPDATE drivers SET status='active' WHERE id=1;"></textarea>
            </div>
            <div class="df g2" style="flex-wrap:wrap">
              <button class="btn btn-da" onclick="runSQL()"><i class="fas fa-play"></i> Wykonaj</button>
              <button class="btn btn-sc" onclick="document.getElementById('sqlQ').value='SELECT * FROM drivers;'">Przyk≈Çad SELECT</button>
              <button class="btn btn-sc" onclick="document.getElementById('sqlQ').value='SELECT * FROM users;'">U≈ºytkownicy</button>
              <button class="btn btn-sc" onclick="document.getElementById('sqlQ').value='SELECT * FROM fuel_records ORDER BY date DESC;'">Paliwo</button>
            </div>
            <div class="sqlres" id="sqlRes"></div>
          </div>
          <div id="atab-a-c" class="cb" style="display:none">
            <div style="max-height:480px;overflow-y:auto"><table class="tbl tbl-str" style="font-size:.76rem">
              <thead><tr><th>Czas</th><th>U≈ºytkownik</th><th>Akcja</th><th>Tabela</th><th>IP</th><th>Szczeg√≥≈Çy</th></tr></thead>
              <tbody id="auditTb"></tbody>
            </table></div>
          </div>
          <div id="atab-d-c" class="cb" style="display:none" id="schemaView"><div id="schemaV"></div></div>
        </div>
      </div>

      <!-- DRIVER COCKPIT -->
      <div class="page" id="pg-driver-cockpit">
        <div class="ph"><h1><i class="fas fa-steering-wheel"></i> M√≥j kokpit</h1>
          <div class="bc"><span>K≈Çosok</span><span class="bcs">‚Ä∫</span><span>Kokpit kierowcy</span></div></div>
        <div class="row" id="dckStats"></div>
        <div class="row">
          <div class="c6"><div class="card"><div class="ch"><div class="ct"><i class="fas fa-calendar-day"></i> Harmonogram ‚Äì dzi≈õ</div></div><div class="cb" id="dckToday"></div></div></div>
          <div class="c6"><div class="card"><div class="ch"><div class="ct"><i class="fas fa-star"></i> Moje punkty (bie≈ºƒÖcy miesiƒÖc)</div></div><div class="cb" id="dckPts"></div></div></div>
        </div>
        <div class="card"><div class="ch"><div class="ct"><i class="fas fa-history"></i> Moje ostatnie kursy</div></div>
          <div class="cb p0"><div style="overflow-x:auto"><table class="tbl tbl-hov">
            <thead><tr><th>Data</th><th>Linia</th><th>Odjazd</th><th>Przyjazd</th><th>Status</th></tr></thead>
            <tbody id="dckHist"></tbody>
          </table></div></div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="page" id="pg-settings">
        <div class="ph"><h1><i class="fas fa-cog"></i> Ustawienia</h1></div>
        <div class="row">
          <div class="c6">
            <div class="card"><div class="ch"><div class="ct"><i class="fas fa-palette"></i> WyglƒÖd</div></div>
              <div class="cb">
                <div class="fg"><label class="fl">Motyw</label>
                  <div class="df g2 mt2">
                    <button class="btn btn-sc" onclick="setTheme('dark')"><i class="fas fa-moon"></i> Ciemny</button>
                    <button class="btn btn-sc" onclick="setTheme('light')"><i class="fas fa-sun"></i> Jasny</button>
                  </div>
                </div>
                <div class="fg"><label class="fl">Sidebar</label>
                  <div class="df g2 mt2">
                    <button class="btn btn-os" onclick="expandSB()"><i class="fas fa-expand-alt"></i> Rozwiniƒôty</button>
                    <button class="btn btn-os" onclick="collapseSB()"><i class="fas fa-compress-alt"></i> Zwiniƒôty</button>
                  </div>
                </div>
                <div class="fg"><label class="fl">Reset danych (‚ö†Ô∏è usuwa wszystko)</label>
                  <div class="mt2">
                    <button class="btn btn-da btn-sm" onclick="if(confirm('Przywr√≥ciƒá dane fabryczne?'))resetDB()"><i class="fas fa-trash-restore"></i> Reset do domy≈õlnych</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="c6">
            <div class="card"><div class="ch"><div class="ct"><i class="fas fa-key"></i> Zmiana has≈Ça</div></div>
              <div class="cb">
                <div class="fg"><label class="fl">Aktualne has≈Ço</label><input type="password" class="fc" id="opw"></div>
                <div class="fg"><label class="fl">Nowe has≈Ço</label><input type="password" class="fc" id="npw"></div>
                <div class="fg"><label class="fl">Potwierd≈∫ has≈Ço</label><input type="password" class="fc" id="cpw"></div>
                <button class="btn btn-pr" onclick="changePw()"><i class="fas fa-save"></i> Zmie≈Ñ has≈Ço</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<div id="modalC"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA STORE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SK = 'klosok_v2';
const DCOLORS = ['#007bff','#28a745','#fd7e14','#6f42c1','#17a2b8','#dc3545','#20c997','#e83e8c'];

const DEF = {
  users:[
    {id:1,username:'admin',email:'admin@klosok.pl',pw:'admin123',role:'admin',fn:'Administrator',ln:'Systemu',active:1,ll:null,did:null},
    {id:2,username:'dyspozytor',email:'disp@klosok.pl',pw:'disp123',role:'dispatcher',fn:'Jan',ln:'Dyspozytor',active:1,ll:null,did:null},
    {id:3,username:'kowalski',email:'jan@klosok.pl',pw:'driver123',role:'driver',fn:'Jan',ln:'Kowalski',active:1,ll:null,did:1},
  ],
  drivers:[
    {id:1,fn:'Jan',ln:'Kowalski',lic:'DRW/001/2020',ph:'500-100-200',em:'jan@klosok.pl',hd:'2020-03-01',st:'active',notes:'',c:'#007bff'},
    {id:2,fn:'Marek',ln:'Nowak',lic:'DRW/002/2019',ph:'500-200-300',em:'marek@klosok.pl',hd:'2019-06-15',st:'active',notes:'',c:'#28a745'},
    {id:3,fn:'Piotr',ln:'Wi≈õniewski',lic:'DRW/003/2021',ph:'500-300-400',em:'piotr@klosok.pl',hd:'2021-01-10',st:'active',notes:'',c:'#fd7e14'},
    {id:4,fn:'Adam',ln:'Zieli≈Ñski',lic:'DRW/004/2018',ph:'500-400-500',em:'adam@klosok.pl',hd:'2018-09-01',st:'vacation',notes:'Urlop do ko≈Ñca maja',c:'#6f42c1'},
  ],
  lines:[
    {id:1,num:'1',name:'Centrum',start:'Dworzec G≈Ç√≥wny',end:'Osiedle S≈Çoneczne',km:12.5,mins:35,col:'#007bff'},
    {id:2,num:'2',name:'Podmiejska',start:'Rynek',end:'Lotnisko',km:22.0,mins:55,col:'#28a745'},
    {id:3,num:'3',name:'Nocna',start:'Centrum',end:'Przemys≈Çowa',km:8.0,mins:25,col:'#6f42c1'},
  ],
  vehicles:[
    {id:1,reg:'WX 12345',brand:'Solaris',model:'Urbino 12',year:2020,cap:80,ft:'diesel',cons:38.5,st:'active',ni:'2025-08-01',ins:'2025-12-31',mil:124500,notes:''},
    {id:2,reg:'WX 23456',brand:'MAN',model:"Lion's City",year:2019,cap:90,ft:'diesel',cons:42.0,st:'active',ni:'2025-07-15',ins:'2025-11-30',mil:198700,notes:''},
    {id:3,reg:'WX 34567',brand:'Volvo',model:'7900',year:2021,cap:85,ft:'cng',cons:35.2,st:'active',ni:'2025-09-01',ins:'2026-01-15',mil:87300,notes:''},
  ],
  schedule:[
    {id:1,did:1,vid:1,lid:1,date:'2025-05-22',dep:'05:30',arr:'08:45',st:'completed',notes:'',brk:[{t:'rest',s:'09:00',e:'09:30',loc:'Zajezdnia'}]},
    {id:2,did:2,vid:2,lid:2,date:'2025-05-22',dep:'06:15',arr:'09:30',st:'completed',notes:'',brk:[{t:'technical',s:'09:45',e:'10:00',loc:''}]},
    {id:3,did:3,vid:3,lid:1,date:'2025-05-22',dep:'10:00',arr:'13:30',st:'completed',notes:'',brk:[{t:'lunch',s:'13:30',e:'14:00',loc:'Stacja'}]},
    {id:4,did:1,vid:1,lid:1,date:'2025-05-22',dep:'13:00',arr:'17:15',st:'in_progress',notes:'',brk:[]},
    {id:5,did:4,vid:1,lid:3,date:'2025-05-22',dep:'16:45',arr:'21:00',st:'planned',notes:'',brk:[{t:'terminal',s:'20:30',e:'21:00',loc:'Terminal'}]},
    {id:6,did:2,vid:2,lid:2,date:'2025-05-22',dep:'14:00',arr:'17:15',st:'in_progress',notes:'',brk:[]},
  ],
  points:[
    {id:1,did:1,date:'2025-05-19',typ:'positive',val:5,cat:'punctuality',desc:'Punktualny przez ca≈Çy tydzie≈Ñ',by:'Dyspozytor'},
    {id:2,did:1,date:'2025-05-17',typ:'positive',val:10,cat:'safety',desc:'Brak incydent√≥w',by:'Kontrola'},
    {id:3,did:1,date:'2025-05-14',typ:'negative',val:6,cat:'behavior',desc:'Sp√≥r z pasa≈ºerem',by:'Skargi'},
    {id:4,did:2,date:'2025-05-20',typ:'positive',val:8,cat:'punctuality',desc:'Zawsze na czas',by:'Dyspozytor'},
    {id:5,did:2,date:'2025-05-15',typ:'positive',val:12,cat:'customer_service',desc:'Pochwa≈Ça pasa≈ºera',by:'Pasa≈ºer'},
    {id:6,did:2,date:'2025-05-10',typ:'negative',val:8,cat:'vehicle_care',desc:'Uszkodzenie lusterka',by:'Inspektor'},
    {id:7,did:3,date:'2025-05-18',typ:'positive',val:9,cat:'safety',desc:'Bezpieczna jazda',by:'Dyspozytor'},
    {id:8,did:3,date:'2025-05-12',typ:'negative',val:6,cat:'punctuality',desc:'Sp√≥≈∫nienie 2x',by:'Dyspozytor'},
    {id:9,did:4,date:'2025-05-08',typ:'negative',val:12,cat:'absence',desc:'Nieuzasadniona nieobecno≈õƒá',by:'Kierownik'},
    {id:10,did:4,date:'2025-05-05',typ:'negative',val:8,cat:'behavior',desc:'Nieodpowiednie zachowanie',by:'Pasa≈ºer'},
    {id:11,did:4,date:'2025-05-01',typ:'positive',val:6,cat:'vehicle_care',desc:'Czyste auto',by:'Inspektor'},
  ],
  fuel:[
    {id:1,vid:1,date:'2025-05-21',L:180,km:496,pr:6.85,notes:'Pe≈Çny bak'},
    {id:2,vid:1,date:'2025-05-18',L:200,km:551,pr:6.82,notes:''},
    {id:3,vid:2,date:'2025-05-20',L:210,km:490,pr:6.90,notes:''},
    {id:4,vid:2,date:'2025-05-16',L:195,km:455,pr:6.85,notes:''},
    {id:5,vid:3,date:'2025-05-19',L:160,km:469,pr:6.80,notes:''},
  ],
  audit:[],
  nid:{u:10,d:10,l:10,v:10,s:20,p:20,f:20}
};

function loadDB(){try{const d=JSON.parse(localStorage.getItem(SK));if(!d)return JSON.parse(JSON.stringify(DEF));['users','drivers','lines','vehicles','schedule','points','fuel','audit'].forEach(k=>{if(!d[k])d[k]=[];});if(!d.nid)d.nid={u:10,d:10,l:10,v:10,s:20,p:20,f:20};return d;}catch{return JSON.parse(JSON.stringify(DEF));}}
function saveDB(){localStorage.setItem(SK,JSON.stringify(DB));}
function resetDB(){localStorage.removeItem(SK);location.reload();}
let DB=loadDB();
function gid(k){const id=DB.nid[k]++;saveDB();return id;}

// Lookups
const byId=(a,id)=>a.find(x=>x.id===+id);
const drv=id=>byId(DB.drivers,id);
const lin=id=>byId(DB.lines,id);
const veh=id=>byId(DB.vehicles,id);
const usr=id=>byId(DB.users,id);
const drvC=id=>{const d=drv(id);return d?.c||DCOLORS[(id-1)%DCOLORS.length];};
const drvIn=d=>d?(d.fn[0]||'')+(d.ln[0]||''):'?';
const drvN=id=>{const d=drv(id);return d?d.fn+' '+d.ln:'‚Äî';};
const linN=id=>{const l=lin(id);return l?`Linia ${l.num} ‚Äì ${l.name}`:'‚Äî';};
const vehN=id=>{const v=veh(id);return v?v.reg:'‚Äî';};
const fmtD=s=>{if(!s)return'‚Äî';try{return new Date(s+'T00:00:00').toLocaleDateString('pl-PL');}catch{return s;}};
const dTo=s=>{if(!s)return null;return Math.round((new Date(s+'T00:00:00')-new Date())/(1000*86400));};

const SL={active:'Aktywny',inactive:'Nieaktywny',vacation:'Urlop',sick:'Choroba',
  planned:'Planowany',in_progress:'W trakcie',completed:'Zako≈Ñczony',cancelled:'Odwo≈Çany',delayed:'Op√≥≈∫niony'};
const SB={active:'ba-su',inactive:'ba-sc',vacation:'ba-wa',sick:'ba-da',
  planned:'ba-pr',in_progress:'ba-wa',completed:'ba-su',cancelled:'ba-da',delayed:'ba-wa'};
const RL={admin:'Administrator',dispatcher:'Dyspozytor',driver:'Kierowca'};
const RB={admin:'ba-da',dispatcher:'ba-pr',driver:'ba-su'};
const CL={punctuality:'Punktualno≈õƒá',behavior:'Zachowanie',safety:'Bezpiecze≈Ñstwo',
  customer_service:'Obs. pasa≈ºera',vehicle_care:'Dba≈Ço≈õƒá o poj.',
  route_adherence:'Przestrz. trasy',absence:'Nieobecno≈õƒá',other:'Inne'};
const BL={rest:'‚òï Przerwa',lunch:'üçΩ Lunch',technical:'üîß Techniczna',terminal:'üèÅ Terminal'};
const BCL={rest:'tsr',lunch:'tsl2',technical:'tst',terminal:'tsterm'};
const FTL={diesel:'Diesel',cng:'CNG',electric:'Elektryczny',hybrid:'Hybryda'};

// Points helpers
const dPts=(id,yr,mo)=>DB.points.filter(p=>{
  if(p.did!==+id)return false;
  if(yr&&!p.date.startsWith(yr))return false;
  if(mo&&p.date.slice(5,7)!==mo.toString().padStart(2,'0'))return false;
  return true;
});
const netP=pts=>pts.reduce((s,p)=>s+(p.typ==='positive'?p.val:-p.val),0);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let CU=null;

function doLogin(){
  const u=g('lUser').trim(),p=g('lPass');
  if(!u||!p){setAl('lAlert','Podaj login i has≈Ço.','d');return;}
  const user=DB.users.find(x=>(x.username===u||x.email===u)&&x.pw===p&&x.active);
  if(!user){setAl('lAlert','Nieprawid≈Çowe dane logowania.','d');return;}
  user.ll=new Date().toISOString();saveDB();
  audit(user.id,'LOGIN',null,null,{});
  CU=user;
  localStorage.setItem('klosok_sess',JSON.stringify({uid:user.id,ts:Date.now()}));
  startApp();
}

function doRegister(){
  const fn=g('rFn'),ln=g('rLn'),un=g('rUn'),em=g('rEm'),pw=g('rPw'),role=g('rRole'),inv=g('rInv');
  if(!un||!em||!pw){setAl('rAlert','Wymagane: login, email, has≈Ço.','d');return;}
  if(pw.length<6){setAl('rAlert','Has≈Ço min. 6 znak√≥w.','d');return;}
  if(role==='admin'&&inv!=='KLOSOK-ADMIN-2025'){setAl('rAlert','Nieprawid≈Çowy kod admina.','d');return;}
  if(DB.users.find(x=>x.username===un||x.email===em)){setAl('rAlert','Login lub email ju≈º zajƒôty.','d');return;}
  DB.users.push({id:gid('u'),username:un,email:em,pw,role,fn,ln,active:1,ll:null,did:null});
  saveDB();setAl('rAlert','Konto utworzone! Zaloguj siƒô.','s');
  setTimeout(showLogin,1300);
}

function doLogout(){
  if(CU)audit(CU.id,'LOGOUT',null,null,{});
  CU=null;
  localStorage.removeItem('klosok_sess');
  document.getElementById('app').style.display='none';
  document.getElementById('loginPg').style.display='flex';
  closeM();
}

function checkSess(){
  const s=localStorage.getItem('klosok_sess');
  if(!s)return false;
  const {uid,ts}=JSON.parse(s);
  if(Date.now()-ts>8*3600*1000){localStorage.removeItem('klosok_sess');return false;}
  CU=DB.users.find(x=>x.id===uid&&x.active);
  return!!CU;
}

function audit(uid,action,tbl,rid,det){
  DB.audit.push({id:DB.audit.length+1,uid,action,tbl,rid,det:JSON.stringify(det||{}),ip:'localhost',ts:new Date().toISOString()});
  if(DB.audit.length>500)DB.audit=DB.audit.slice(-500);
  saveDB();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP START ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startApp(){
  document.getElementById('loginPg').style.display='none';
  document.getElementById('app').style.display='flex';
  buildNav();updateTopbar();loadTheme();loadSBState();
  document.getElementById('schDate').value='2025-05-22';
  document.getElementById('bdDate').value='2025-05-22';
  popVehSelects();popDrvSelects();
  const def={admin:'dashboard',dispatcher:'dashboard',driver:'driver-cockpit'}[CU.role]||'dashboard';
  showPage(def);
}

function updateTopbar(){
  document.getElementById('topName').textContent=`${CU.fn} ${CU.ln}`;
  document.getElementById('topRole').textContent=RL[CU.role]||CU.role;
  const av=document.getElementById('topAv');
  av.textContent=(CU.fn[0]||'')+(CU.ln[0]||'');
  av.style.background=CU.role==='admin'?'linear-gradient(135deg,#dc3545,#bd2130)':CU.role==='dispatcher'?'linear-gradient(135deg,#007bff,#0056b3)':'linear-gradient(135deg,#28a745,#1e7e34)';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const NAVS={
  admin:[
    {p:'dashboard',ic:'fas fa-tachometer-alt',lb:'Dashboard'},
    {h:'ZARZƒÑDZANIE'},
    {p:'drivers',ic:'fas fa-id-card',lb:'Kierowcy',bd:'drv'},
    {p:'vehicles',ic:'fas fa-bus',lb:'Pojazdy',bd:'veh'},
    {p:'lines',ic:'fas fa-route',lb:'Linie',bd:'lin'},
    {h:'OPERACJE'},
    {p:'schedule',ic:'fas fa-calendar-alt',lb:'Harmonogram'},
    {p:'points',ic:'fas fa-star',lb:'Punkty'},
    {p:'fuel',ic:'fas fa-gas-pump',lb:'Paliwo'},
    {p:'substitution',ic:'fas fa-exchange-alt',lb:'Podstawianie'},
    {h:'SYSTEM'},
    {p:'admin',ic:'fas fa-shield-alt',lb:'Panel Admina'},
    {p:'settings',ic:'fas fa-cog',lb:'Ustawienia'},
  ],
  dispatcher:[
    {p:'dashboard',ic:'fas fa-tachometer-alt',lb:'Dashboard'},
    {h:'ZARZƒÑDZANIE'},
    {p:'drivers',ic:'fas fa-id-card',lb:'Kierowcy'},
    {p:'vehicles',ic:'fas fa-bus',lb:'Pojazdy'},
    {p:'lines',ic:'fas fa-route',lb:'Linie'},
    {h:'OPERACJE'},
    {p:'schedule',ic:'fas fa-calendar-alt',lb:'Harmonogram'},
    {p:'points',ic:'fas fa-star',lb:'Punkty'},
    {p:'fuel',ic:'fas fa-gas-pump',lb:'Paliwo'},
    {p:'substitution',ic:'fas fa-exchange-alt',lb:'Podstawianie'},
    {h:'SYSTEM'},
    {p:'settings',ic:'fas fa-cog',lb:'Ustawienia'},
  ],
  driver:[
    {p:'driver-cockpit',ic:'fas fa-tachometer-alt',lb:'M√≥j kokpit'},
    {p:'schedule',ic:'fas fa-calendar-alt',lb:'Harmonogram'},
    {p:'points',ic:'fas fa-star',lb:'Punkty'},
    {h:'SYSTEM'},
    {p:'settings',ic:'fas fa-cog',lb:'Ustawienia'},
  ]
};

function getBadge(k){
  if(k==='drv')return DB.drivers.filter(d=>d.st==='active').length;
  if(k==='veh')return DB.vehicles.filter(v=>v.st==='active').length;
  if(k==='lin')return DB.lines.length;
  return 0;
}

function buildNav(){
  const items=NAVS[CU.role]||NAVS.dispatcher;
  document.getElementById('snav').innerHTML=items.map(item=>{
    if(item.h)return`<div class="mhdr">${item.h}</div>`;
    const cnt=item.bd?getBadge(item.bd):0;
    const badge=cnt?`<span class="nbadge b">${cnt}</span>`:'';
    return`<div class="ni" id="ni-${item.p}" data-tip="${item.lb}" onclick="showPage('${item.p}',this)"><i class="nic ${item.ic}"></i><span class="nlb">${item.lb}</span>${badge}</div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROUTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PTITLES={dashboard:'Dashboard',drivers:'Kierowcy',vehicles:'Pojazdy',lines:'Linie',
  schedule:'Harmonogram',points:'Punkty',fuel:'Paliwo',substitution:'Podstawianie',
  admin:'Panel Admina',settings:'Ustawienia','driver-cockpit':'M√≥j Kokpit'};
const PREND={dashboard:renderDash,drivers:renderDrivers,vehicles:renderVehicles,
  lines:renderLines,schedule:renderSched,points:renderPoints,fuel:renderFuel,
  substitution:renderSub,admin:renderAdmin,'driver-cockpit':renderDCockpit,settings:()=>{}};

function showPage(name,navEl){
  if(name==='admin'&&CU.role!=='admin'){toast('Brak uprawnie≈Ñ.','err');return;}
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el=document.getElementById('pg-'+name);if(el)el.classList.add('active');
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  const ne=navEl||document.getElementById('ni-'+name);if(ne)ne.classList.add('active');
  document.getElementById('tbTitle').textContent=PTITLES[name]||name;
  PREND[name]?.();
  if(window.innerWidth<=768)closeMob();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadTheme(){setTheme(localStorage.getItem('klosok_theme')||'dark');}
function setTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('thBtn').innerHTML=t==='dark'?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>';
  localStorage.setItem('klosok_theme',t);
}
function toggleTheme(){setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let SBCol=false;
function loadSBState(){SBCol=localStorage.getItem('klosok_sb')==='1';if(SBCol)collapseSB(false);}
function collapseSB(sv=true){SBCol=true;document.getElementById('sidebar').classList.add('col');document.getElementById('main').classList.add('col');if(sv)localStorage.setItem('klosok_sb','1');}
function expandSB(sv=true){SBCol=false;document.getElementById('sidebar').classList.remove('col');document.getElementById('main').classList.remove('col');if(sv)localStorage.setItem('klosok_sb','0');}
function toggleSB(){
  if(window.innerWidth<=768){document.getElementById('sidebar').classList.toggle('mopen');document.getElementById('sovl').classList.toggle('show');}
  else{SBCol?expandSB():collapseSB();}
}
function closeMob(){document.getElementById('sidebar').classList.remove('mopen');document.getElementById('sovl').classList.remove('show');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showM(h){document.getElementById('modalC').innerHTML=h;}
function closeM(){document.getElementById('modalC').innerHTML='';}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toast(msg,type='ok'){
  const icons={ok:'fa-check-circle',err:'fa-times-circle',inf:'fa-info-circle',wrn:'fa-exclamation-triangle'};
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  t.innerHTML=`<i class="fas ${icons[type]||icons.ok} ti"></i><span>${msg}</span>`;
  document.getElementById('toastC').appendChild(t);
  setTimeout(()=>t.remove(),3150);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function g(id){const e=document.getElementById(id);return e?e.value:'';}
function setAl(id,msg,t='d'){const e=document.getElementById(id);if(e)e.innerHTML=msg?`<div class="alert al-${t}">${msg}</div>`:'';};
function toggleUD(){document.getElementById('udrop').classList.toggle('show');}
document.addEventListener('click',e=>{if(!e.target.closest('.umenu'))document.getElementById('udrop')?.classList.remove('show');});
function showReg(){document.getElementById('loginView').style.display='none';document.getElementById('regView').style.display='';}
function showLogin(){document.getElementById('regView').style.display='none';document.getElementById('loginView').style.display='';}
function toggleInvite(){document.getElementById('invGrp').style.display=g('rRole')==='admin'?'':'none';}

function popVehSelects(){
  const opts='<option value="">Pojazd‚Ä¶</option>'+DB.vehicles.map(v=>`<option value="${v.id}">${v.reg}</option>`).join('');
  const el=document.getElementById('bdBus');if(el)el.innerHTML=opts;
}
function popDrvSelects(){
  const opts='<option value="">Wszyscy</option>'+DB.drivers.map(d=>`<option value="${d.id}">${d.fn} ${d.ln}</option>`).join('');
  ['schDrvF','ptFDrv'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=opts;});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TLS=5,TLH=17;
function tp(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return Math.max(0,Math.min(100,((h-TLS)*60+(m||0))/(TLH*60)*100));}
function tdp(s,e){if(!s||!e)return 0;const[sh,sm]=s.split(':').map(Number);const[eh,em]=e.split(':').map(Number);return Math.max(.5,((eh*60+em)-(sh*60+sm))/(TLH*60)*100);}
function showTip(ev,txt){const t=document.getElementById('tlTip');t.textContent=txt;t.style.display='block';t.style.left=(ev.clientX+10)+'px';t.style.top=(ev.clientY-30)+'px';}
function hideTip(){document.getElementById('tlTip').style.display='none';}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDash(){
  const today='2025-05-22';
  const actD=DB.drivers.filter(d=>d.st==='active').length;
  const todS=DB.schedule.filter(s=>s.date===today);
  const actV=DB.vehicles.filter(v=>v.st==='active').length;
  const moPts=DB.points.filter(p=>p.date.startsWith('2025-05'));
  const net=netP(moPts);

  document.getElementById('dStats').innerHTML=`
    <div class="c3"><div class="ibox"><div class="iic bg-b"><i class="fas fa-id-card"></i></div><div class="ixc"><div class="ixt">Aktywni kierowcy</div><div class="ixn">${actD}</div><div class="ixs">z ${DB.drivers.length} ≈ÇƒÖcznie</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-g"><i class="fas fa-calendar-check"></i></div><div class="ixc"><div class="ixt">Kurs√≥w dzi≈õ</div><div class="ixn">${todS.length}</div><div class="ixs">${todS.filter(s=>s.st==='completed').length} uko≈Ñczonych</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-a"><i class="fas fa-bus"></i></div><div class="ixc"><div class="ixt">Aktywne pojazdy</div><div class="ixn">${actV}</div><div class="ixs">z ${DB.vehicles.length} ≈ÇƒÖcznie</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic ${net>=0?'bg-g':'bg-r'}"><i class="fas fa-star"></i></div><div class="ixc"><div class="ixt">Saldo punkt√≥w (maj)</div><div class="ixn ${net>=0?'ts':'td'}">${net>0?'+':''}${net}</div><div class="ixs">${moPts.length} wpis√≥w</div></div></div></div>
  `;

  document.getElementById('dSched').innerHTML=`<div class="card"><div class="ch"><div class="ct"><i class="fas fa-clock"></i> Harmonogram ‚Äì 22.05.2025</div>
    <button class="btn btn-op btn-xs" onclick="showPage('schedule')">Wszystkie ‚Üí</button></div>
    <div class="cb p0"><table class="tbl tbl-hov"><tbody>${todS.slice(0,6).map(s=>{
      const d=drv(s.did),l=lin(s.lid);
      return`<tr><td class="mono" style="width:100px">${s.dep} ‚Äì ${s.arr||'?'}</td>
        <td><div class="dcell"><div class="dav" style="background:${drvC(s.did)}">${d?drvIn(d):'?'}</div>${d?d.fn+' '+d.ln:'‚Äî'}</div></td>
        <td>Linia ${l?.num||'‚Äî'}</td>
        <td><span class="badge ${SB[s.st]||'ba-sc'}">${SL[s.st]||s.st}</span></td></tr>`;
    }).join('')}</tbody></table></div></div>`;

  const ranked=DB.drivers.map(d=>{const pts=dPts(d.id,'2025','05');return{...d,pos:pts.filter(p=>p.typ==='positive').reduce((s,p)=>s+p.val,0),neg:pts.filter(p=>p.typ==='negative').reduce((s,p)=>s+p.val,0),net:netP(pts)};}).sort((a,b)=>b.net-a.net);
  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('dRank').innerHTML=`<div class="card"><div class="ch"><div class="ct"><i class="fas fa-trophy"></i> Ranking (maj)</div>
    <button class="btn btn-op btn-xs" onclick="showPage('points')">Szczeg√≥≈Çy ‚Üí</button></div>
    <div class="cb">${ranked.map((d,i)=>`<div class="pbrow"><div class="pbrank">${medals[i]||i+1}</div>
      <div class="pbname">${d.fn[0]}. ${d.ln}</div>
      <div class="pbbars">${d.pos?`<div class="pbpos" style="flex:${d.pos}">${d.pos>5?'+'+d.pos:''}</div>`:''}${d.neg?`<div class="pbneg" style="flex:${d.neg}">${d.neg>5?'-'+d.neg:''}</div>`:''}</div>
      <div class="pbnet ${d.net>=0?'ts':'td'}">${d.net>0?'+':''}${d.net}</div></div>`).join('')}
    </div></div>`;

  const alerts=DB.vehicles.filter(v=>{const di=dTo(v.ni),da=dTo(v.ins);return(di!==null&&di<=30)||(da!==null&&da<=30);});
  document.getElementById('dAlerts').innerHTML=alerts.length?`<div class="card"><div class="ch"><div class="ct"><i class="fas fa-exclamation-triangle tw"></i> Alerty ‚Äì zbli≈ºajƒÖce siƒô terminy</div></div>
    <div class="cb p0"><table class="tbl"><tbody>${alerts.map(v=>`<tr>
      <td><strong>${v.reg}</strong> ${v.brand} ${v.model}</td>
      <td>PrzeglƒÖd: <strong>${fmtD(v.ni)}</strong> <span class="badge ${dTo(v.ni)<=7?'ba-da':'ba-wa'}">${dTo(v.ni)} dni</span></td>
      <td>Ubezpieczenie: <strong>${fmtD(v.ins)}</strong></td>
    </tr>`).join('')}</tbody></table></div></div>`:'';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRIVERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDrivers(){
  const sf=g('drvSF'),srch=(g('drvSrch')||'').toLowerCase();
  const list=DB.drivers.filter(d=>(!sf||d.st===sf)&&(!srch||`${d.fn} ${d.ln} ${d.lic}`.toLowerCase().includes(srch)));
  const ce=CU.role!=='driver';
  document.getElementById('drvEmpty').style.display=list.length?'none':'block';
  document.getElementById('drvTb').innerHTML=list.map(d=>{
    const pts=dPts(d.id,'2025','05'),net=netP(pts);
    return`<tr>
      <td><div class="dcell"><div class="dav" style="background:${d.c}">${drvIn(d)}</div><div><div class="fw7">${d.fn} ${d.ln}</div><div style="font-size:.7rem;color:var(--tm)">${d.em||'‚Äî'}</div></div></div></td>
      <td class="mono" style="font-size:.76rem">${d.lic}</td>
      <td>${d.ph||'‚Äî'}</td>
      <td style="color:var(--tm)">${d.hd}</td>
      <td><span class="badge ${SB[d.st]||'ba-sc'}">${SL[d.st]}</span></td>
      <td class="mono fw7 ${net>=0?'ts':'td'}">${net>0?'+':''}${net}</td>
      <td>${ce?`<button class="btn btn-in btn-xs btn-ic" onclick="openDrvForm(${d.id})"><i class="fas fa-edit"></i></button> <button class="btn btn-da btn-xs btn-ic" onclick="delDrv(${d.id})"><i class="fas fa-trash"></i></button>`:'‚Äî'}</td>
    </tr>`;
  }).join('');
}

function openDrvForm(id){
  const d=id?drv(id):null;
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md"><div class="mhd">
    <span class="mti"><i class="fas fa-id-card"></i> ${d?'Edytuj':'Nowy'} kierowca</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="dfA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Imiƒô *</label><input class="fc" id="dfFn" value="${d?.fn||''}"></div>
      <div class="fg"><label class="fl">Nazwisko *</label><input class="fc" id="dfLn" value="${d?.ln||''}"></div>
    </div>
    <div class="fg"><label class="fl">Nr prawa jazdy *</label><input class="fc" id="dfLic" placeholder="DRW/001/2025" value="${d?.lic||''}"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Telefon</label><input class="fc" id="dfPh" value="${d?.ph||''}"></div>
      <div class="fg"><label class="fl">Email</label><input class="fc" type="email" id="dfEm" value="${d?.em||''}"></div>
    </div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Data zatrudnienia *</label><input class="fc" type="date" id="dfHd" value="${d?.hd||''}"></div>
      <div class="fg"><label class="fl">Status</label><select class="fc" id="dfSt">
        ${['active','inactive','vacation','sick'].map(s=>`<option value="${s}" ${d?.st===s?'selected':''}>${SL[s]}</option>`).join('')}
      </select></div>
    </div>
    <div class="fg"><label class="fl">Uwagi</label><textarea class="fc" id="dfNt" rows="2">${d?.notes||''}</textarea></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveDrv(${id||0})"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function saveDrv(id){
  const fn=g('dfFn'),ln=g('dfLn'),lic=g('dfLic'),hd=g('dfHd');
  if(!fn||!ln||!lic||!hd){setAl('dfA','Wype≈Çnij wymagane pola.');return;}
  if(id){const d=drv(id);Object.assign(d,{fn,ln,lic,ph:g('dfPh'),em:g('dfEm'),hd,st:g('dfSt'),notes:g('dfNt')});audit(CU.id,'UPDATE','drivers',id,{});}
  else{const c=DCOLORS[DB.drivers.length%DCOLORS.length];DB.drivers.push({id:gid('d'),fn,ln,lic,ph:g('dfPh'),em:g('dfEm'),hd,st:g('dfSt'),notes:g('dfNt'),c});audit(CU.id,'CREATE','drivers',null,{});}
  saveDB();toast(id?'Zaktualizowano.':'Dodano kierowcƒô.');closeM();renderDrivers();buildNav();popDrvSelects();
}
function delDrv(id){
  const d=drv(id);if(!confirm(`UsunƒÖƒá ${d.fn} ${d.ln}?`))return;
  DB.drivers=DB.drivers.filter(x=>x.id!==id);DB.points=DB.points.filter(p=>p.did!==id);DB.schedule=DB.schedule.filter(s=>s.did!==id);
  saveDB();audit(CU.id,'DELETE','drivers',id,{});toast('Usuniƒôto.');renderDrivers();buildNav();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VEHICLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderVehicles(){
  const sf=g('vehSF');
  const list=DB.vehicles.filter(v=>!sf||v.st===sf);
  document.getElementById('vehEmpty').style.display=list.length?'none':'block';
  const ce=CU.role!=='driver';
  const maxL=Math.max(...DB.vehicles.map(v=>DB.fuel.filter(f=>f.vid===v.id).reduce((s,f)=>s+f.L,0)),1);

  document.getElementById('vehGrid').innerHTML=list.map(v2=>{
    const fr=DB.fuel.filter(f=>f.vid===v2.id);
    const tL=fr.reduce((s,f)=>s+f.L,0),tK=fr.reduce((s,f)=>s+(f.km||0),0);
    const avg=tK>0?tL/tK*100:v2.cons||0;
    const di=dTo(v2.ni),da=dTo(v2.ins);
    const cls=avg<40?'ts':avg>45?'td':'tw';
    return`<div class="c4"><div class="vcard">
      <div class="vch">
        <div class="vic"><i class="fas fa-bus"></i></div>
        <div><div class="vreg">${v2.reg}</div><div class="vmod">${v2.brand} ${v2.model} (${v2.year})</div></div>
        <span class="badge ${SB[v2.st]||'ba-sc'}" style="margin-left:auto">${{active:'Aktywny',maintenance:'Serwis',inactive:'Nieaktywny'}[v2.st]||v2.st}</span>
      </div>
      <div class="vcb">
        <div class="vst"><span class="vsl"><i class="fas fa-users"></i> Pojemno≈õƒá</span><span class="vsv">${v2.cap||'‚Äî'} os.</span></div>
        <div class="vst"><span class="vsl"><i class="fas fa-gas-pump"></i> Paliwo</span><span class="vsv">${FTL[v2.ft]||v2.ft}</span></div>
        <div class="vst"><span class="vsl"><i class="fas fa-chart-line"></i> Spalanie</span><span class="vsv ${cls}">${avg.toFixed(1)} L/100km</span></div>
        <div class="vst"><span class="vsl"><i class="fas fa-tachometer-alt"></i> Przebieg</span><span class="vsv mono">${(v2.mil||0).toLocaleString()} km</span></div>
        <div class="vst"><span class="vsl"><i class="fas fa-wrench"></i> PrzeglƒÖd</span><span class="vsv ${di!==null&&di<=30?di<=7?'td':'tw':''}">${fmtD(v2.ni)} ${di!==null&&di<=30?`<span class="badge ${di<=7?'ba-da':'ba-wa'}">${di}d</span>`:''}</span></div>
        <div class="vst"><span class="vsl"><i class="fas fa-shield-alt"></i> Ubezpieczenie</span><span class="vsv ${da!==null&&da<=30?da<=7?'td':'tw':''}">${fmtD(v2.ins)}</span></div>
      </div>
      ${ce?`<div class="vcf"><button class="btn btn-in btn-xs" onclick="openVehForm(${v2.id})"><i class="fas fa-edit"></i> Edytuj</button><button class="btn btn-da btn-xs" onclick="delVeh(${v2.id})"><i class="fas fa-trash"></i> Usu≈Ñ</button></div>`:''}
    </div></div>`;
  }).join('');

  // Alerts
  const als=DB.vehicles.filter(v2=>{const di=dTo(v2.ni),da=dTo(v2.ins);return(di!==null&&di<=30)||(da!==null&&da<=30);});
  const ac=document.getElementById('vehAlerts');
  ac.style.display=als.length?'':'none';
  document.getElementById('vehAlertTb').innerHTML=als.map(v2=>`<tr>
    <td><strong>${v2.reg}</strong> ${v2.brand} ${v2.model}</td>
    <td>${fmtD(v2.ni)} <span class="badge ${dTo(v2.ni)<=7?'ba-da':'ba-wa'}">${dTo(v2.ni)} dni</span></td>
    <td>${fmtD(v2.ins)} <span class="badge ${dTo(v2.ins)<=7?'ba-da':'ba-wa'}">${dTo(v2.ins)} dni</span></td>
  </tr>`).join('');
  buildNav();
}

function openVehForm(id){
  const v2=id?veh(id):null;
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md lg"><div class="mhd">
    <span class="mti"><i class="fas fa-bus"></i> ${v2?'Edytuj':'Nowy'} pojazd</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="vfA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Rejestracja *</label><input class="fc" id="vfReg" placeholder="WX 12345" value="${v2?.reg||''}"></div>
      <div class="fg"><label class="fl">Status</label><select class="fc" id="vfSt">
        ${['active','maintenance','inactive'].map(s=>`<option value="${s}" ${v2?.st===s?'selected':''}>${{active:'Aktywny',maintenance:'Serwis',inactive:'Nieaktywny'}[s]}</option>`).join('')}
      </select></div>
    </div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Marka *</label><input class="fc" id="vfBr" placeholder="Solaris" value="${v2?.brand||''}"></div>
      <div class="fg"><label class="fl">Model *</label><input class="fc" id="vfMo" placeholder="Urbino 12" value="${v2?.model||''}"></div>
    </div>
    <div class="fr fr3">
      <div class="fg"><label class="fl">Rok</label><input class="fc" type="number" id="vfYr" value="${v2?.year||''}"></div>
      <div class="fg"><label class="fl">Pojemno≈õƒá (os.)</label><input class="fc" type="number" id="vfCap" value="${v2?.cap||''}"></div>
      <div class="fg"><label class="fl">Paliwo</label><select class="fc" id="vfFt">
        ${['diesel','cng','electric','hybrid'].map(f=>`<option value="${f}" ${v2?.ft===f?'selected':''}>${FTL[f]}</option>`).join('')}
      </select></div>
    </div>
    <div class="fr fr3">
      <div class="fg"><label class="fl">≈ör. spalanie (L/100km)</label><input class="fc" type="number" step="0.1" id="vfCons" value="${v2?.cons||''}"></div>
      <div class="fg"><label class="fl">Poj. baku (L)</label><input class="fc" type="number" id="vfTank" value="${v2?.tank||''}"></div>
      <div class="fg"><label class="fl">Przebieg (km)</label><input class="fc" type="number" id="vfMil" value="${v2?.mil||0}"></div>
    </div>
    <div class="fr fr3">
      <div class="fg"><label class="fl">Ostatni przeglƒÖd</label><input class="fc" type="date" id="vfLi" value="${v2?.li||''}"></div>
      <div class="fg"><label class="fl">Nastƒôpny przeglƒÖd</label><input class="fc" type="date" id="vfNi" value="${v2?.ni||''}"></div>
      <div class="fg"><label class="fl">Ubezpieczenie do</label><input class="fc" type="date" id="vfIns" value="${v2?.ins||''}"></div>
    </div>
    <div class="fg"><label class="fl">Uwagi</label><textarea class="fc" id="vfNt" rows="2">${v2?.notes||''}</textarea></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveVeh(${id||0})"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function saveVeh(id){
  const reg=g('vfReg'),brand=g('vfBr'),model=g('vfMo');
  if(!reg||!brand||!model){setAl('vfA','Wymagane: rejestracja, marka, model.');return;}
  const data={reg,brand,model,year:parseInt(g('vfYr'))||null,cap:parseInt(g('vfCap'))||null,ft:g('vfFt')||'diesel',cons:parseFloat(g('vfCons'))||null,tank:parseFloat(g('vfTank'))||null,mil:parseInt(g('vfMil'))||0,st:g('vfSt')||'active',li:g('vfLi')||null,ni:g('vfNi')||null,ins:g('vfIns')||null,notes:g('vfNt')};
  if(id){Object.assign(veh(id),data);}else{DB.vehicles.push({id:gid('v'),...data});}
  saveDB();audit(CU.id,id?'UPDATE':'CREATE','vehicles',id||null,{});toast(id?'Zaktualizowano.':'Dodano pojazd.');closeM();renderVehicles();popVehSelects();
}
function delVeh(id){
  const v2=veh(id);if(!confirm(`UsunƒÖƒá ${v2.reg}?`))return;
  DB.vehicles=DB.vehicles.filter(x=>x.id!==id);saveDB();toast('Usuniƒôto.');renderVehicles();popVehSelects();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LINES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderLines(){
  const ce=CU.role!=='driver';
  document.getElementById('linesTb').innerHTML=DB.lines.map(l=>`<tr>
    <td><span class="badge" style="background:${l.col||'#007bff'};font-size:.88rem;padding:3px 11px">${l.num}</span></td>
    <td><strong>${l.name}</strong></td>
    <td>${l.start}</td><td>${l.end}</td>
    <td>${l.km?l.km+' km':'‚Äî'}</td><td>${l.mins?l.mins+' min':'‚Äî'}</td>
    <td>${ce?`<button class="btn btn-in btn-xs btn-ic" onclick="openLineForm(${l.id})"><i class="fas fa-edit"></i></button> <button class="btn btn-da btn-xs btn-ic" onclick="delLine(${l.id})"><i class="fas fa-trash"></i></button>`:'‚Äî'}</td>
  </tr>`).join('');
  buildNav();
}
function openLineForm(id){
  const l=id?lin(id):null;
  const COLS=['#007bff','#28a745','#6f42c1','#fd7e14','#17a2b8','#dc3545'];
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md"><div class="mhd">
    <span class="mti"><i class="fas fa-route"></i> ${l?'Edytuj':'Nowa'} linia</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="lfA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Numer *</label><input class="fc" id="lfNum" placeholder="1, 2A, N3" value="${l?.num||''}"></div>
      <div class="fg"><label class="fl">Nazwa *</label><input class="fc" id="lfName" value="${l?.name||''}"></div>
    </div>
    <div class="fg"><label class="fl">Przystanek poczƒÖtkowy *</label><input class="fc" id="lfStart" value="${l?.start||''}"></div>
    <div class="fg"><label class="fl">Przystanek ko≈Ñcowy *</label><input class="fc" id="lfEnd" value="${l?.end||''}"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Dystans (km)</label><input class="fc" type="number" step="0.1" id="lfKm" value="${l?.km||''}"></div>
      <div class="fg"><label class="fl">Czas (min)</label><input class="fc" type="number" id="lfMins" value="${l?.mins||''}"></div>
    </div>
    <div class="fg"><label class="fl">Kolor</label><div class="df g2" style="margin-top:4px;flex-wrap:wrap">${COLS.map(c=>`<div onclick="document.getElementById('lfCol').value='${c}';document.querySelectorAll('.cdot').forEach(x=>x.style.outline='none');this.style.outline='3px solid var(--tp)'" class="cdot" style="width:26px;height:26px;border-radius:50%;background:${c};cursor:pointer;outline:${l?.col===c?'3px solid var(--tp)':'none'}"></div>`).join('')}
    <input type="hidden" id="lfCol" value="${l?.col||'#007bff'}"></div></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveLine(${id||0})"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function saveLine(id){
  const num=g('lfNum'),name=g('lfName'),start=g('lfStart'),end=g('lfEnd');
  if(!num||!name||!start||!end){setAl('lfA','Wype≈Çnij wymagane pola.');return;}
  const data={num,name,start,end,km:parseFloat(g('lfKm'))||null,mins:parseInt(g('lfMins'))||null,col:g('lfCol')||'#007bff'};
  if(id){Object.assign(lin(id),data);}else{DB.lines.push({id:gid('l'),...data});}
  saveDB();toast(id?'Zaktualizowano.':'Dodano liniƒô.');closeM();renderLines();
  const lf=document.getElementById('schLineF');if(lf)lf.innerHTML='<option value="">Wszystkie</option>'+DB.lines.map(l=>`<option value="${l.id}">Linia ${l.num}</option>`).join('');
}
function delLine(id){
  if(!confirm('UsunƒÖƒá tƒô liniƒô?'))return;
  DB.lines=DB.lines.filter(x=>x.id!==id);saveDB();toast('Usuniƒôto.');renderLines();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCHEDULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSched(){
  const date=g('schDate')||'2025-05-22',fdrv=g('schDrvF'),fline=g('schLineF');
  const lf=document.getElementById('schLineF');
  if(lf&&lf.children.length<=1)lf.innerHTML='<option value="">Wszystkie</option>'+DB.lines.map(l=>`<option value="${l.id}">Linia ${l.num}</option>`).join('');

  let list=DB.schedule.filter(s=>{
    if(s.date!==date)return false;
    if(fdrv&&s.did!==+fdrv)return false;
    if(fline&&s.lid!==+fline)return false;
    if(CU.role==='driver'&&s.did!==CU.did)return false;
    return true;
  });

  // TIMELINE Y=lines
  const tLines=fline?[+fline]:DB.lines.map(l=>l.id);
  const hrs=[5,7,9,11,13,15,17,19,21];
  let tlHtml=`<div class="tlh"><div class="tlyl"></div><div class="tlhs">${hrs.map(h=>`<div class="tlhl">${String(h).padStart(2,'0')}:00</div>`).join('')}</div></div>`;
  tlHtml+=tLines.map(lid=>{
    const l=lin(lid);if(!l)return'';
    const items=list.filter(s=>s.lid===lid);
    const segs=items.map(s=>{
      const d=drv(s.did);const c=drvC(s.did);const dn=d?`${d.fn[0]}. ${d.ln}`:'?';
      let h=`<div class="tlseg tsd" style="left:${tp(s.dep)}%;width:${tdp(s.dep,s.arr)}%;background:${c}" onmouseenter="showTip(event,'${dn} ¬∑ ${s.dep}‚Äì${s.arr||'?'}')" onmouseleave="hideTip()" onclick="openSchForm(${s.id})"><span class="tlsl">${dn}</span></div>`;
      (s.brk||[]).forEach(b=>{const bc=BCL[b.t]||'tsr';h+=`<div class="tlseg ${bc}" style="left:${tp(b.s)}%;width:${tdp(b.s,b.e)}%;z-index:5" onmouseenter="showTip(event,'${BL[b.t]||b.t}: ${b.s}‚Äì${b.e}${b.loc?' ¬∑ '+b.loc:''}')" onmouseleave="hideTip()"></div>`;});
      return h;
    }).join('');
    return`<div class="tlrow"><div class="tlyn"><div class="df ac g2"><span class="badge" style="background:${l.col}">${l.num}</span><span>${l.name}</span></div><div class="tlys">${l.start} ‚Üí ${l.end}</div></div><div class="tlbar">${segs||'<div style="height:100%;display:flex;align-items:center;padding:0 7px;font-size:.68rem;color:var(--tm)">Brak kurs√≥w</div>'}</div></div>`;
  }).join('');
  document.getElementById('tlGrid').innerHTML=tlHtml;

  // List
  const ce=CU.role!=='driver';
  list.sort((a,b)=>a.dep.localeCompare(b.dep));
  document.getElementById('schEmpty').style.display=list.length?'none':'block';
  document.getElementById('schTb').innerHTML=list.map(s=>{
    const d=drv(s.did),l=lin(s.lid),v2=veh(s.vid);
    const bks=(s.brk||[]).map(b=>`<span class="badge ba-sc ba-pi" style="font-size:.62rem">${BL[b.t]||b.t}</span>`).join(' ');
    return`<tr>
      <td class="mono fw7">${s.dep}</td>
      <td>${l?`<span class="badge" style="background:${l.col}">Linia ${l.num}</span> ${l.name}`:'‚Äî'}</td>
      <td><div class="dcell"><div class="dav" style="background:${drvC(s.did)};width:22px;height:22px">${d?drvIn(d):'?'}</div>${d?d.fn+' '+d.ln:'‚Äî'}</div></td>
      <td class="mono" style="font-size:.76rem">${v2?.reg||'‚Äî'}</td>
      <td class="mono">${s.arr||'‚Äî'}</td>
      <td><span class="badge ${SB[s.st]||'ba-sc'}">${SL[s.st]||s.st}</span></td>
      <td>${bks||'‚Äî'}</td>
      <td>${ce?`<button class="btn btn-in btn-xs btn-ic" onclick="openSchForm(${s.id})"><i class="fas fa-edit"></i></button> <button class="btn btn-da btn-xs btn-ic" onclick="delSch(${s.id})"><i class="fas fa-trash"></i></button>`:'‚Äî'}</td>
    </tr>`;
  }).join('');
}

function openSchForm(id){
  const s=id?DB.schedule.find(x=>x.id===id):null;
  const date=g('schDate')||'2025-05-22';
  const dO=DB.drivers.map(d=>`<option value="${d.id}" ${s?.did===d.id?'selected':''}>${d.fn} ${d.ln}</option>`).join('');
  const vO='<option value="">Brak</option>'+DB.vehicles.map(v2=>`<option value="${v2.id}" ${s?.vid===v2.id?'selected':''}>${v2.reg} ‚Äì ${v2.brand}</option>`).join('');
  const lO='<option value="">Brak</option>'+DB.lines.map(l=>`<option value="${l.id}" ${s?.lid===l.id?'selected':''}>${l.num} ‚Äì ${l.name}</option>`).join('');
  const stO=['planned','in_progress','completed','cancelled','delayed'].map(st=>`<option value="${st}" ${(s?.st||'planned')===st?'selected':''}>${SL[st]}</option>`).join('');
  const brkRows=(s?.brk||[]).map(b=>brkRow(b)).join('');
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md lg"><div class="mhd">
    <span class="mti"><i class="fas fa-calendar-plus"></i> ${s?'Edytuj':'Nowy'} kurs</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="sfA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Kierowca *</label><select class="fc" id="sfDrv">${dO}</select></div>
      <div class="fg"><label class="fl">Data *</label><input class="fc" type="date" id="sfDt" value="${s?.date||date}"></div>
    </div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Pojazd</label><select class="fc" id="sfVeh">${vO}</select></div>
      <div class="fg"><label class="fl">Linia</label><select class="fc" id="sfLine">${lO}</select></div>
    </div>
    <div class="fr fr3">
      <div class="fg"><label class="fl">Odjazd *</label><input class="fc" type="time" id="sfDep" value="${s?.dep||''}"></div>
      <div class="fg"><label class="fl">Przyjazd</label><input class="fc" type="time" id="sfArr" value="${s?.arr||''}"></div>
      <div class="fg"><label class="fl">Status</label><select class="fc" id="sfSt">${stO}</select></div>
    </div>
    <div class="df ac" style="justify-content:space-between;margin-bottom:7px">
      <span class="fl" style="margin:0"><i class="fas fa-coffee"></i> Przerwy</span>
      <button class="btn btn-os btn-xs" onclick="addBrk()"><i class="fas fa-plus"></i> Dodaj</button>
    </div>
    <div id="sfBrks">${brkRows}</div>
    <div class="fg"><label class="fl">Uwagi</label><input class="fc" id="sfNt" value="${s?.notes||''}"></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveSch(${id||0})"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function brkRow(b={}){
  return`<div class="fr" style="grid-template-columns:1fr 1fr 1fr 1fr auto;gap:5px;margin-bottom:5px">
    <input class="fc" type="time" value="${b.s||''}">
    <input class="fc" type="time" value="${b.e||''}">
    <select class="fc">${['rest','lunch','technical','terminal'].map(t=>`<option value="${t}" ${b.t===t?'selected':''}>${BL[t]}</option>`).join('')}</select>
    <input class="fc" placeholder="Lokalizacja" value="${b.loc||''}">
    <button class="btn btn-da btn-xs btn-ic" onclick="this.closest('.fr').remove()"><i class="fas fa-times"></i></button>
  </div>`;
}
function addBrk(){const c=document.getElementById('sfBrks');const d=document.createElement('div');d.innerHTML=brkRow();c.appendChild(d.firstElementChild);}
function saveSch(id){
  const did=g('sfDrv'),dt=g('sfDt'),dep=g('sfDep');
  if(!did||!dt||!dep){setAl('sfA','Wymagane: kierowca, data, odjazd.');return;}
  const brk=[...document.getElementById('sfBrks').querySelectorAll('.fr')].map(r=>{
    const ins=r.querySelectorAll('input,select');
    return{s:ins[0]?.value||'',e:ins[1]?.value||'',t:ins[2]?.value||'rest',loc:ins[3]?.value||''};
  }).filter(b=>b.s&&b.e);
  const data={did:+did,vid:parseInt(g('sfVeh'))||null,lid:parseInt(g('sfLine'))||null,date:dt,dep,arr:g('sfArr'),st:g('sfSt')||'planned',notes:g('sfNt'),brk};
  if(id){Object.assign(DB.schedule.find(x=>x.id===id),data);}else{DB.schedule.push({id:gid('s'),...data});}
  saveDB();toast(id?'Zaktualizowano.':'Dodano kurs.');closeM();renderSched();
}
function delSch(id){if(!confirm('UsunƒÖƒá kurs?'))return;DB.schedule=DB.schedule.filter(s=>s.id!==id);saveDB();toast('Usuniƒôto.');renderSched();}

function openRangeForm(){
  const dO=DB.drivers.map(d=>`<option value="${d.id}">${d.fn} ${d.ln}</option>`).join('');
  const vO='<option value="">Brak</option>'+DB.vehicles.map(v2=>`<option value="${v2.id}">${v2.reg}</option>`).join('');
  const lO='<option value="">Brak</option>'+DB.lines.map(l=>`<option value="${l.id}">${l.num} ‚Äì ${l.name}</option>`).join('');
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md lg"><div class="mhd">
    <span class="mti"><i class="fas fa-calendar-week"></i> Generuj kurs ‚Äì zakres dat</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div class="alert al-i"><i class="fas fa-info-circle"></i> Kurs generowany dla ka≈ºdego wybranego dnia tygodnia w podanym zakresie dat. Duplikaty pomijane.</div>
    <div id="rgA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Kierowca *</label><select class="fc" id="rgDrv">${dO}</select></div>
      <div class="fg"><label class="fl">Pojazd</label><select class="fc" id="rgVeh">${vO}</select></div>
    </div>
    <div class="fg"><label class="fl">Linia</label><select class="fc" id="rgLine">${lO}</select></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Data od *</label><input class="fc" type="date" id="rgFrom" value="2025-05-26"></div>
      <div class="fg"><label class="fl">Data do *</label><input class="fc" type="date" id="rgTo" value="2025-05-30"></div>
    </div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Odjazd *</label><input class="fc" type="time" id="rgDep"></div>
      <div class="fg"><label class="fl">Przyjazd</label><input class="fc" type="time" id="rgArr"></div>
    </div>
    <div class="fg"><label class="fl">Dni tygodnia</label>
      <div class="df g2" style="margin-top:5px;flex-wrap:wrap">
        ${[['Nd',0],['Pn',1],['Wt',2],['≈ör',3],['Cz',4],['Pt',5],['Sb',6]].map(([n,v])=>`<label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" class="rgdow" value="${v}" ${v>=1&&v<=5?'checked':''}> ${n}</label>`).join('')}
      </div>
    </div>
    <div class="df ac" style="justify-content:space-between;margin-bottom:7px">
      <span class="fl" style="margin:0">Przerwy</span>
      <button class="btn btn-os btn-xs" onclick="addRgBrk()"><i class="fas fa-plus"></i></button>
    </div>
    <div id="rgBrks"></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveRange()"><i class="fas fa-magic"></i> Generuj</button></div></div></div>`);
}
function addRgBrk(){const c=document.getElementById('rgBrks');const d=document.createElement('div');d.innerHTML=brkRow();c.appendChild(d.firstElementChild);}
function saveRange(){
  const did=g('rgDrv'),from=g('rgFrom'),to=g('rgTo'),dep=g('rgDep');
  if(!did||!from||!to||!dep){setAl('rgA','Wymagane: kierowca, daty, odjazd.');return;}
  const dows=new Set([...document.querySelectorAll('.rgdow:checked')].map(x=>+x.value));
  const brk=[...document.getElementById('rgBrks').querySelectorAll('.fr')].map(r=>{const ins=r.querySelectorAll('input,select');return{s:ins[0]?.value||'',e:ins[1]?.value||'',t:ins[2]?.value||'rest',loc:ins[3]?.value||''};}).filter(b=>b.s&&b.e);
  const start=new Date(from+'T00:00:00'),end=new Date(to+'T00:00:00');
  let created=0;
  for(const d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
    if(!dows.has(d.getDay()))continue;
    const ds=d.toISOString().split('T')[0];
    const exists=DB.schedule.find(s=>s.did===+did&&s.lid===(parseInt(g('rgLine'))||null)&&s.date===ds&&s.dep===dep);
    if(exists)continue;
    DB.schedule.push({id:gid('s'),did:+did,vid:parseInt(g('rgVeh'))||null,lid:parseInt(g('rgLine'))||null,date:ds,dep,arr:g('rgArr'),st:'planned',notes:'',brk:[...brk]});
    created++;
  }
  saveDB();toast(`Wygenerowano ${created} kurs√≥w.`,'inf');closeM();renderSched();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê POINTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPoints(){
  const yr=g('ptYr')||'2025',mo=g('ptMo')||'';
  const pts=DB.points.filter(p=>{
    if(!p.date.startsWith(yr))return false;
    if(mo&&p.date.slice(5,7)!==mo.padStart(2,'0'))return false;
    if(CU.role==='driver'&&p.did!==CU.did)return false;
    return true;
  });
  const pos=pts.filter(p=>p.typ==='positive').reduce((s,p)=>s+p.val,0);
  const neg=pts.filter(p=>p.typ==='negative').reduce((s,p)=>s+p.val,0);
  document.getElementById('ptStats').innerHTML=`
    <div class="c3"><div class="ibox"><div class="iic bg-g"><i class="fas fa-thumbs-up"></i></div><div class="ixc"><div class="ixt">Pkt. dodatnie</div><div class="ixn ts">+${pos}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-r"><i class="fas fa-thumbs-down"></i></div><div class="ixc"><div class="ixt">Pkt. ujemne</div><div class="ixn td">-${neg}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic ${pos-neg>=0?'bg-b':'bg-r'}"><i class="fas fa-balance-scale"></i></div><div class="ixc"><div class="ixt">Saldo</div><div class="ixn ${pos-neg>=0?'ts':'td'}">${pos-neg>0?'+':''}${pos-neg}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-i"><i class="fas fa-list"></i></div><div class="ixc"><div class="ixt">Wpisy</div><div class="ixn">${pts.length}</div></div></div></div>`;

  const ranked=DB.drivers.map(d=>{const dp=dPts(d.id,yr,mo);return{...d,pos2:dp.filter(p=>p.typ==='positive').reduce((s,p)=>s+p.val,0),neg2:dp.filter(p=>p.typ==='negative').reduce((s,p)=>s+p.val,0),net:netP(dp)};}).sort((a,b)=>b.net-a.net);
  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('ptRank').innerHTML=ranked.map((d,i)=>`
    <div class="pbrow"><div class="pbrank">${medals[i]||i+1}</div>
      <div class="pbname"><div class="dcell"><div class="dav" style="background:${d.c};width:20px;height:20px;font-size:.6rem">${drvIn(d)}</div>${d.fn[0]}. ${d.ln}</div></div>
      <div class="pbbars">
        ${d.pos2?`<div class="pbpos" style="flex:${d.pos2}">${d.pos2>5?'+'+d.pos2:''}</div>`:''}
        ${d.neg2?`<div class="pbneg" style="flex:${d.neg2}">${d.neg2>5?'-'+d.neg2:''}</div>`:''}
      </div>
      <div class="pbnet ${d.net>=0?'ts':'td'}">${d.net>0?'+':''}${d.net}</div>
    </div>`).join('');

  const fd=document.getElementById('ptFDrv');const cur=fd?.value;
  if(fd)fd.innerHTML='<option value="">Wszyscy</option>'+DB.drivers.map(d=>`<option value="${d.id}" ${cur==d.id?'selected':''}>${d.fn} ${d.ln}</option>`).join('');
  renderPtEntries();
}
function renderPtEntries(){
  const fdrv=g('ptFDrv'),ftyp=g('ptFTyp');
  let ents=DB.points.filter(p=>{
    if(fdrv&&p.did!==+fdrv)return false;
    if(ftyp&&p.typ!==ftyp)return false;
    if(CU.role==='driver'&&p.did!==CU.did)return false;
    return true;
  }).sort((a,b)=>b.date.localeCompare(a.date));
  const ce=CU.role!=='driver';
  document.getElementById('ptEntries').innerHTML=ents.length?`<table class="tbl tbl-hov" style="font-size:.79rem">
    <thead><tr><th>Data</th><th>Kierowca</th><th>Kategoria</th><th>Opis</th><th>Wart.</th>${ce?'<th></th>':''}</tr></thead>
    <tbody>${ents.map(p=>{const d=drv(p.did);return`<tr>
      <td class="mono" style="font-size:.7rem;white-space:nowrap">${p.date}</td>
      <td style="white-space:nowrap">${d?d.fn+' '+d.ln:'‚Äî'}</td>
      <td><span class="badge ba-sc ba-pi">${CL[p.cat]||p.cat}</span></td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.desc||''}">${p.desc||'‚Äî'}</td>
      <td class="mono fw7 ${p.typ==='positive'?'ts':'td'}">${p.typ==='positive'?'+':'-'}${p.val}</td>
      ${ce?`<td><button class="btn btn-da btn-xs btn-ic" onclick="delPt(${p.id})"><i class="fas fa-trash"></i></button></td>`:''}
    </tr>`;}).join('')}</tbody></table>` : '<div class="empty" style="padding:18px"><i class="fas fa-star-half-alt"></i>Brak wpis√≥w</div>';
}
function openPtForm(){
  const dO=DB.drivers.map(d=>`<option value="${d.id}">${d.fn} ${d.ln}</option>`).join('');
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md"><div class="mhd">
    <span class="mti"><i class="fas fa-star"></i> Dodaj wpis punktowy</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="pfA"></div>
    <div class="fg"><label class="fl">Kierowca *</label><select class="fc" id="pfDrv">${dO}</select></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Data *</label><input class="fc" type="date" id="pfDt" value="2025-05-22"></div>
      <div class="fg"><label class="fl">Typ *</label><select class="fc" id="pfTyp"><option value="positive">‚úÖ Dodatni</option><option value="negative">‚ùå Ujemny</option></select></div>
    </div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Warto≈õƒá (1-50)</label><input class="fc" type="number" id="pfVal" min="1" max="50" value="5"></div>
      <div class="fg"><label class="fl">Kategoria *</label><select class="fc" id="pfCat">
        ${Object.entries(CL).map(([k,lb])=>`<option value="${k}">${lb}</option>`).join('')}
      </select></div>
    </div>
    <div class="fg"><label class="fl">Opis</label><textarea class="fc" id="pfDesc" rows="2"></textarea></div>
    <div class="fg"><label class="fl">Zg≈ÇaszajƒÖcy</label><input class="fc" id="pfBy" value="${CU.fn} ${CU.ln}"></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="savePt()"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function savePt(){
  const did=g('pfDrv'),dt=g('pfDt'),val=parseInt(g('pfVal')),cat=g('pfCat'),typ=g('pfTyp');
  if(!did||!dt||!val||!cat){setAl('pfA','Wymagane: kierowca, data, warto≈õƒá.');return;}
  DB.points.push({id:gid('p'),did:+did,date:dt,typ,val,cat,desc:g('pfDesc'),by:g('pfBy')});
  saveDB();toast('Dodano wpis.');closeM();renderPoints();
}
function delPt(id){if(!confirm('UsunƒÖƒá wpis?'))return;DB.points=DB.points.filter(p=>p.id!==id);saveDB();toast('Usuniƒôto.');renderPoints();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FUEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderFuel(){
  const yr=g('fuYr')||'2025',mo=g('fuMo')||'';
  const maxL=Math.max(...DB.vehicles.map(v2=>DB.fuel.filter(f=>f.vid===v2.id&&f.date.startsWith(yr)&&(!mo||f.date.slice(5,7)===mo.padStart(2,'0'))).reduce((s,f)=>s+f.L,0)),1);
  document.getElementById('fuSum').innerHTML=DB.vehicles.map(v2=>{
    const recs=DB.fuel.filter(f=>f.vid===v2.id&&f.date.startsWith(yr)&&(!mo||f.date.slice(5,7)===mo.padStart(2,'0')));
    const tL=recs.reduce((s,f)=>s+f.L,0),tK=recs.reduce((s,f)=>s+(f.km||0),0);
    const avg=tK>0?tL/tK*100:v2.cons||0;
    const cls=avg<40?'ts':avg>45?'td':'tw';
    return`<div style="margin-bottom:13px;padding:11px;background:var(--ts);border-radius:4px">
      <div class="df ac" style="justify-content:space-between;margin-bottom:5px">
        <div><div class="fw7 mono">${v2.reg}</div><div style="font-size:.7rem;color:var(--tm)">${v2.brand} ${v2.model}</div></div>
        <div class="fw7 ${cls}">${avg.toFixed(1)} L/100km</div>
      </div>
      <div class="fpbar"><div class="fpfill" style="width:${tL/maxL*100}%"></div></div>
      <div class="df ac" style="justify-content:space-between;font-size:.7rem;color:var(--tm);margin-top:3px">
        <span>${tL.toFixed(0)} L ≈ÇƒÖcznie</span><span>${tK.toFixed(0)} km</span>
      </div>
    </div>`;
  }).join('');

  const sorted=[...DB.fuel].sort((a,b)=>b.date.localeCompare(a.date));
  document.getElementById('fuTb').innerHTML=sorted.map(f=>{
    const v2=veh(f.vid);const avg=f.km>0?f.L/f.km*100:null;
    return`<tr>
      <td class="mono" style="font-size:.76rem">${f.date}</td>
      <td><strong>${v2?.reg||'‚Äî'}</strong></td>
      <td>${f.L} L</td><td>${f.km||'‚Äî'}</td>
      <td class="mono ${avg?avg<40?'ts':avg>45?'td':'tw':''}">${avg?avg.toFixed(1):'‚Äî'}</td>
      <td>${f.pr?(f.L*f.pr).toFixed(2)+' z≈Ç':'‚Äî'}</td>
      <td><button class="btn btn-da btn-xs btn-ic" onclick="delFu(${f.id})"><i class="fas fa-trash"></i></button></td>
    </tr>`;
  }).join('');
  renderBD();
}
function renderBD(){
  const busId=parseInt(g('bdBus'))||null,date=g('bdDate')||'';
  const el=document.getElementById('fuBD');
  if(!busId||!date){el.innerHTML='<div class="empty"><i class="fas fa-info-circle"></i>Wybierz pojazd i datƒô</div>';return;}
  const scheds=DB.schedule.filter(s=>s.vid===busId&&s.date===date);
  const fuelDay=DB.fuel.filter(f=>f.vid===busId&&f.date===date);
  const totalL=fuelDay.reduce((s,f)=>s+f.L,0),totalKm=fuelDay.reduce((s,f)=>s+(f.km||0),0);
  if(!scheds.length){el.innerHTML='<div class="empty"><i class="fas fa-calendar-times"></i>Brak kurs√≥w w tym dniu</div>';return;}
  const wd=scheds.map(s=>{const[sh,sm]=(s.dep||'0:0').split(':').map(Number);const[eh,em]=(s.arr||s.dep||'0:0').split(':').map(Number);return{...s,dur:Math.max(0,(eh*60+em)-(sh*60+sm))};});
  const tm=wd.reduce((s,w)=>s+w.dur,0)||1;
  el.innerHTML=`<div style="font-size:.76rem;color:var(--tm);margin-bottom:11px">≈ÅƒÖcznie: <strong>${totalL} L</strong> ¬∑ <strong>${totalKm} km</strong></div>`+
  wd.map(w=>{const d=drv(w.did);const shr=w.dur/tm;return`<div style="margin-bottom:11px;padding:9px;background:var(--ts);border-radius:4px">
    <div class="df ac" style="justify-content:space-between">
      <div><div class="fw7">${d?d.fn+' '+d.ln:'‚Äî'}</div><div style="font-size:.7rem;color:var(--tm)">${w.dep}‚Äì${w.arr||'?'} (${w.dur} min)</div></div>
      <div class="tr2"><div class="fw7 tp2 mono">${(totalL*shr).toFixed(1)} L</div><div style="font-size:.7rem;color:var(--tm)">${Math.round(shr*100)}%</div></div>
    </div>
    <div class="fpbar mt2"><div class="fpfill" style="width:${shr*100}%"></div></div>
  </div>`;}).join('');
}
function openFuForm(){
  const vO=DB.vehicles.map(v2=>`<option value="${v2.id}">${v2.reg} ‚Äì ${v2.brand} ${v2.model}</option>`).join('');
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md"><div class="mhd">
    <span class="mti"><i class="fas fa-gas-pump"></i> Dodaj tankowanie</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="ffA"></div>
    <div class="fg"><label class="fl">Pojazd *</label><select class="fc" id="ffVeh">${vO}</select></div>
    <div class="fg"><label class="fl">Data *</label><input class="fc" type="date" id="ffDt" value="2025-05-22"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Litry *</label><input class="fc" type="number" step="0.5" id="ffL" placeholder="180"></div>
      <div class="fg"><label class="fl">Przejechane km</label><input class="fc" type="number" id="ffKm" placeholder="496"></div>
    </div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Cena / litr (z≈Ç)</label><input class="fc" type="number" step="0.01" id="ffPr" placeholder="6.85"></div>
      <div class="fg"><label class="fl">Odczyt licznika</label><input class="fc" type="number" id="ffOd"></div>
    </div>
    <div class="fg"><label class="fl">Uwagi</label><input class="fc" id="ffNt"></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveFu()"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function saveFu(){
  const vid=g('ffVeh'),dt=g('ffDt'),L=parseFloat(g('ffL'));
  if(!vid||!dt||!L){setAl('ffA','Wymagane: pojazd, data, litry.');return;}
  DB.fuel.push({id:gid('f'),vid:+vid,date:dt,L,km:parseFloat(g('ffKm'))||0,pr:parseFloat(g('ffPr'))||0,notes:g('ffNt')});
  saveDB();toast('Dodano tankowanie.');closeM();renderFuel();
}
function delFu(id){if(!confirm('UsunƒÖƒá?'))return;DB.fuel=DB.fuel.filter(f=>f.id!==id);saveDB();toast('Usuniƒôto.');renderFuel();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUBSTITUTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSub(){
  const yr=g('subYr')||'2025',mo=g('subMo')||'05';
  const ranked=DB.drivers.map(d=>{
    const pts=dPts(d.id,yr,mo);const net=netP(pts);
    const punP=pts.filter(p=>p.cat==='punctuality'&&p.typ==='positive').reduce((s,p)=>s+p.val,0);
    const absP=pts.filter(p=>p.cat==='absence').reduce((s,p)=>s+p.val,0);
    const fr=DB.fuel.filter(f=>{const sc=DB.schedule.find(s=>s.did===d.id&&s.date===f.date&&s.vid===f.vid);return!!sc;});
    const avgFu=fr.length?fr.reduce((s,f)=>s+(f.km>0?f.L/f.km*100:0),0)/fr.length:null;
    const score=(net*0.4)+(punP*0.2)+(d.st==='active'?10:0)-(absP*0.5)+(avgFu?Math.max(0,(45-avgFu)):0)*0.25;
    return{...d,net,punP,absP,avgFu,score:Math.round(score)};
  }).sort((a,b)=>b.score-a.score);

  document.getElementById('subStats').innerHTML=`
    <div class="c3"><div class="ibox"><div class="iic bg-g"><i class="fas fa-check-circle"></i></div><div class="ixc"><div class="ixt">Dostƒôpni</div><div class="ixn">${DB.drivers.filter(d=>d.st==='active').length}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-a"><i class="fas fa-exclamation-circle"></i></div><div class="ixc"><div class="ixt">Urlop/choroba</div><div class="ixn">${DB.drivers.filter(d=>d.st==='vacation'||d.st==='sick').length}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-b"><i class="fas fa-medal"></i></div><div class="ixc"><div class="ixt">Najlepszy wynik</div><div class="ixn">${ranked[0]?.score||0}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-i"><i class="fas fa-users"></i></div><div class="ixc"><div class="ixt">≈ÅƒÖcznie</div><div class="ixn">${DB.drivers.length}</div></div></div></div>`;

  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('subRank').innerHTML=ranked.map((d,i)=>`
    <div class="rcard ${i<3?'r'+(i+1):'rn'}">
      <div class="rnum">${i<3?medals[i]:i+1}</div>
      <div class="rinfo">
        <div class="rname"><div class="dcell"><div class="dav" style="background:${d.c};width:22px;height:22px;font-size:.62rem">${drvIn(d)}</div>${d.fn} ${d.ln}</div></div>
        <div class="rsub">Pkt: <strong>${d.net>0?'+':''}${d.net}</strong> | Punkt.: <strong>+${d.punP}</strong>${d.avgFu?` | Spalanie: <strong>${d.avgFu.toFixed(1)}L</strong>`:''}</div>
      </div>
      <div class="tr2"><div class="rscore ${d.score>=0?'pos':'neg'}">${d.score}</div><span class="badge ${SB[d.st]||'ba-sc'}">${SL[d.st]}</span></div>
    </div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRIVER COCKPIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDCockpit(){
  if(!CU.did){document.getElementById('pg-driver-cockpit').innerHTML='<div class="empty"><i class="fas fa-unlink"></i>Konto niepowiƒÖzane z profilem kierowcy. Skontaktuj siƒô z administratorem.</div>';return;}
  const d=drv(CU.did);const today='2025-05-22';
  const todS=DB.schedule.filter(s=>s.did===CU.did&&s.date===today);
  const moPts=dPts(CU.did,'2025','05');const net=netP(moPts);

  document.getElementById('dckStats').innerHTML=`
    <div class="c3"><div class="ibox"><div class="iic bg-b"><i class="fas fa-calendar-day"></i></div><div class="ixc"><div class="ixt">Kursy dzi≈õ</div><div class="ixn">${todS.length}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic ${net>=0?'bg-g':'bg-r'}"><i class="fas fa-star"></i></div><div class="ixc"><div class="ixt">Pkt netto (maj)</div><div class="ixn ${net>=0?'ts':'td'}">${net>0?'+':''}${net}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic bg-i"><i class="fas fa-id-card"></i></div><div class="ixc"><div class="ixt">Nr prawa jazdy</div><div class="ixn" style="font-size:.97rem">${d?.lic||'‚Äî'}</div></div></div></div>
    <div class="c3"><div class="ibox"><div class="iic ${d?.st==='active'?'bg-g':'bg-a'}"><i class="fas fa-user-check"></i></div><div class="ixc"><div class="ixt">Status</div><div class="ixn" style="font-size:.97rem">${SL[d?.st]||'‚Äî'}</div></div></div></div>`;

  document.getElementById('dckToday').innerHTML=todS.length?todS.map(s=>{const l=lin(s.lid),v2=veh(s.vid);return`<div style="padding:9px;margin-bottom:7px;background:var(--ts);border-radius:4px;border-left:4px solid var(--primary)">
    <div class="fw7">${s.dep} ‚Äì ${s.arr||'?'}</div>
    <div style="font-size:.8rem;color:var(--tm)">${l?`Linia ${l.num} ‚Äì ${l.name}`:''} ¬∑ ${v2?.reg||'Brak pojazdu'}</div>
    <div style="margin-top:5px"><span class="badge ${SB[s.st]}">${SL[s.st]}</span></div>
  </div>`;}).join(''):'<div class="empty"><i class="fas fa-calendar-times"></i>Brak kurs√≥w dzi≈õ</div>';

  document.getElementById('dckPts').innerHTML=`<div style="margin-bottom:7px"><strong class="${net>=0?'ts':'td'}">${net>0?'+':''}${net} pkt netto</strong> w maju 2025</div>`+
    moPts.slice(-8).reverse().map(p=>`<div class="df ac g2" style="padding:3px 0;border-bottom:1px solid var(--bc)">
      <span style="font-size:.7rem;color:var(--tm);width:78px">${p.date}</span>
      <span class="badge ${p.typ==='positive'?'ba-su':'ba-da'}">${p.typ==='positive'?'+':'-'}${p.val}</span>
      <span style="font-size:.76rem;color:var(--tm)">${CL[p.cat]||p.cat}</span>
    </div>`).join('');

  const hist=DB.schedule.filter(s=>s.did===CU.did).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10);
  document.getElementById('dckHist').innerHTML=hist.map(s=>{const l=lin(s.lid);return`<tr>
    <td class="mono" style="font-size:.76rem">${s.date}</td>
    <td>${l?`Linia ${l.num}`:s.lid||'‚Äî'}</td>
    <td class="mono">${s.dep}</td><td class="mono">${s.arr||'‚Äî'}</td>
    <td><span class="badge ${SB[s.st]||'ba-sc'}">${SL[s.st]||s.st}</span></td>
  </tr>`;}).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderAdmin(){
  if(CU.role!=='admin')return;
  const tabs=['users','drivers','lines','vehicles','schedule','points','fuel','audit'];
  document.getElementById('adminStats').innerHTML=tabs.slice(0,4).map((t,i)=>{
    const ics=['fa-users','fa-id-card','fa-route','fa-bus'];
    const cls=['bg-b','bg-g','bg-a','bg-p'];
    const counts={users:DB.users.length,drivers:DB.drivers.length,lines:DB.lines.length,vehicles:DB.vehicles.length};
    return`<div class="c3"><div class="ibox"><div class="iic ${cls[i]}"><i class="fas ${ics[i]}"></i></div><div class="ixc"><div class="ixt">${t}</div><div class="ixn">${counts[t]||0}</div></div></div></div>`;
  }).join('');
  renderUsersTb();loadAudit();
}

function renderUsersTb(){
  document.getElementById('usersTb').innerHTML=DB.users.map(u=>`<tr>
    <td class="mono">${u.id}</td>
    <td><strong>${u.username}</strong></td>
    <td>${u.email}</td>
    <td><span class="badge ${RB[u.role]||'ba-sc'}">${RL[u.role]||u.role}</span></td>
    <td>${u.fn} ${u.ln}</td>
    <td style="font-size:.73rem;color:var(--tm)">${u.ll?new Date(u.ll).toLocaleString('pl-PL'):'Nigdy'}</td>
    <td><span class="badge ${u.active?'ba-su':'ba-sc'}">${u.active?'Tak':'Nie'}</span></td>
    <td>
      <button class="btn btn-in btn-xs btn-ic" onclick="openUserForm(${u.id})"><i class="fas fa-edit"></i></button>
      ${u.id!==CU.id?`<button class="btn btn-da btn-xs btn-ic" onclick="delUser(${u.id})"><i class="fas fa-trash"></i></button>`:''}
    </td>
  </tr>`).join('');
}

function openUserForm(id){
  const u=id?usr(id):null;
  const dO='<option value="">Brak (nie kierowca)</option>'+DB.drivers.map(d=>`<option value="${d.id}" ${u?.did===d.id?'selected':''}>${d.fn} ${d.ln}</option>`).join('');
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md"><div class="mhd">
    <span class="mti"><i class="fas fa-user"></i> ${u?'Edytuj':'Nowy'} u≈ºytkownik</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div id="ufA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Imiƒô</label><input class="fc" id="ufFn" value="${u?.fn||''}"></div>
      <div class="fg"><label class="fl">Nazwisko</label><input class="fc" id="ufLn" value="${u?.ln||''}"></div>
    </div>
    <div class="fg"><label class="fl">Login *</label><input class="fc" id="ufUn" value="${u?.username||''}"></div>
    <div class="fg"><label class="fl">Email *</label><input class="fc" type="email" id="ufEm" value="${u?.email||''}"></div>
    <div class="fg"><label class="fl">Has≈Ço ${u?'(puste = bez zmian)':'*'}</label><input class="fc" type="password" id="ufPw" placeholder="${u?'bez zmian':'min. 6 znak√≥w'}"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Rola</label><select class="fc" id="ufRole">
        ${['admin','dispatcher','driver'].map(r=>`<option value="${r}" ${u?.role===r?'selected':''}>${RL[r]}</option>`).join('')}
      </select></div>
      <div class="fg"><label class="fl">Aktywny</label><select class="fc" id="ufAct">
        <option value="1" ${u?.active!==0?'selected':''}>Tak</option>
        <option value="0" ${u?.active===0?'selected':''}>Nie</option>
      </select></div>
    </div>
    <div class="fg"><label class="fl">PowiƒÖzany kierowca</label><select class="fc" id="ufDrv">${dO}</select></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveUser(${id||0})"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function saveUser(id){
  const un=g('ufUn'),em=g('ufEm'),pw=g('ufPw');
  if(!un||!em){setAl('ufA','Wymagane: login, email.');return;}
  if(!id&&!pw){setAl('ufA','Podaj has≈Ço dla nowego konta.');return;}
  if(pw&&pw.length<6){setAl('ufA','Has≈Ço min. 6 znak√≥w.');return;}
  if(DB.users.find(x=>x.id!==id&&(x.username===un||x.email===em))){setAl('ufA','Login lub email zajƒôty.');return;}
  if(id){const u=usr(id);u.fn=g('ufFn');u.ln=g('ufLn');u.username=un;u.email=em;u.role=g('ufRole');u.active=parseInt(g('ufAct'));u.did=parseInt(g('ufDrv'))||null;if(pw)u.pw=pw;}
  else{DB.users.push({id:gid('u'),username:un,email:em,pw,role:g('ufRole'),fn:g('ufFn'),ln:g('ufLn'),active:parseInt(g('ufAct')),ll:null,did:parseInt(g('ufDrv'))||null});}
  saveDB();audit(CU.id,id?'UPDATE':'CREATE','users',id||null,{});toast('Zapisano.');closeM();renderUsersTb();
}
function delUser(id){
  if(!confirm('UsunƒÖƒá u≈ºytkownika?'))return;
  DB.users=DB.users.filter(u=>u.id!==id);saveDB();toast('Usuniƒôto.');renderUsersTb();
}

function swAdminTab(name,btn){
  ['u','s','a','d'].forEach(t=>{const el=document.getElementById(`atab-${t}-c`);if(el)el.style.display='none';document.getElementById(`atab-${t}`)?.style?.removeProperty('border-bottom');});
  document.getElementById(`atab-${name}-c`).style.display='';
  if(btn){btn.style.borderBottom='2px solid var(--primary)';btn.style.fontWeight='700';}
  if(name==='a')loadAudit();
  if(name==='d')loadSchema();
}

function runSQL(){
  const q=document.getElementById('sqlQ').value.trim();
  if(!q){toast('Wpisz zapytanie.','wrn');return;}
  audit(CU.id,'SQL_QUERY',null,null,{q:q.substring(0,200)});
  try{
    const up=q.toUpperCase().trim();
    let result;
    if(up.startsWith('SELECT')||up.startsWith('WITH')){
      const tm=q.match(/FROM\s+(\w+)/i);const tn=tm?tm[1].toLowerCase():'';
      const MAP={users:DB.users,drivers:DB.drivers,lines:DB.lines,vehicles:DB.vehicles,schedule:DB.schedule,driver_points:DB.points,fuel_records:DB.fuel,audit_log:DB.audit};
      const rows=MAP[tn]||[];const lm=q.match(/LIMIT\s+(\d+)/i);const lim=lm?parseInt(lm[1]):rows.length;
      const sliced=rows.slice(0,lim);
      if(!sliced.length){document.getElementById('sqlRes').innerHTML='<div class="alert al-i">Brak wynik√≥w lub tabela nieznana.</div>';return;}
      const cols=Object.keys(sliced[0]);
      document.getElementById('sqlRes').innerHTML=`<div style="overflow-x:auto"><table class="tbl tbl-str" style="font-size:.76rem"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${sliced.map(r=>`<tr>${cols.map(c=>`<td>${r[c]??'NULL'}</td>`).join('')}</tr>`).join('')}</tbody></table></div><div style="font-size:.73rem;color:var(--tm);margin-top:5px">${sliced.length} wierszy (demo: tylko tabele lokalne)</div>`;
    } else if(up.startsWith('UPDATE')){
      const tnm=q.match(/UPDATE\s+(\w+)/i);const tn=tnm?tnm[1].toLowerCase():'';
      document.getElementById('sqlRes').innerHTML=`<div class="alert al-w"><i class="fas fa-info-circle"></i> Zapytanie UPDATE na tabeli "${tn}". W trybie demo zapytania modyfikujƒÖce dzia≈ÇajƒÖ przez API backendowe. U≈ºyj formularzy powy≈ºej lub po≈ÇƒÖcz z backendem Express.js.</div>`;
    } else {
      document.getElementById('sqlRes').innerHTML='<div class="alert al-w">Zapytania INSERT/UPDATE/DELETE wymagajƒÖ po≈ÇƒÖczenia z backendem Express.js. Dostƒôpne w trybie demo: tylko SELECT.</div>';
    }
  }catch(e){document.getElementById('sqlRes').innerHTML=`<div class="alert al-d">B≈ÇƒÖd: ${e.message}</div>`;}
}

function loadAudit(){
  const tb=document.getElementById('auditTb');if(!tb)return;
  tb.innerHTML=[...DB.audit].reverse().slice(0,100).map(a=>{
    const u=usr(a.uid);
    return`<tr>
      <td class="mono" style="font-size:.7rem;white-space:nowrap">${new Date(a.ts).toLocaleString('pl-PL')}</td>
      <td>${u?u.username:'‚Äî'}</td>
      <td><span class="badge ba-in ba-pi">${a.action}</span></td>
      <td>${a.tbl||'‚Äî'}</td>
      <td class="mono">${a.ip||'‚Äî'}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.7rem">${a.det||'‚Äî'}</td>
    </tr>`;
  }).join('');
}
function loadSchema(){
  const el=document.getElementById('schemaV');if(!el)return;
  const tables=[{n:'users',d:DB.users},{n:'drivers',d:DB.drivers},{n:'lines',d:DB.lines},{n:'vehicles',d:DB.vehicles},{n:'schedule',d:DB.schedule},{n:'driver_points',d:DB.points},{n:'fuel_records',d:DB.fuel},{n:'audit_log',d:DB.audit}];
  el.innerHTML=tables.map(t=>{
    const cols=Object.keys(t.d[0]||{});
    return`<div style="margin-bottom:12px"><div class="fw7 mono tp2" style="margin-bottom:5px">üìã ${t.n} <span style="color:var(--tm);font-size:.76rem">(${t.d.length} rekord√≥w)</span></div>
    <div class="df g2" style="flex-wrap:wrap">${cols.map(c=>`<span class="badge ba-sc" style="font-family:monospace">${c}</span>`).join('')}</div></div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE / SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showProfile(){
  closeM();document.getElementById('udrop').classList.remove('show');
  showM(`<div class="mov" onclick="if(event.target===this)closeM()"><div class="md"><div class="mhd">
    <span class="mti"><i class="fas fa-user-cog"></i> Profil u≈ºytkownika</span>
    <button class="mcl" onclick="closeM()">‚úï</button></div><div class="mbd">
    <div class="df ac g3" style="margin-bottom:14px">
      <div class="uav" style="width:46px;height:46px;font-size:1.1rem;background:var(--primary)">${(CU.fn[0]||'')}${(CU.ln[0]||'')}</div>
      <div><div class="fw7" style="font-size:.97rem">${CU.fn} ${CU.ln}</div><div style="color:var(--tm);font-size:.8rem">${CU.email} ¬∑ <span class="badge ${RB[CU.role]}">${RL[CU.role]}</span></div></div>
    </div>
    <div id="profA"></div>
    <div class="fr fr2">
      <div class="fg"><label class="fl">Imiƒô</label><input class="fc" id="prFn" value="${CU.fn}"></div>
      <div class="fg"><label class="fl">Nazwisko</label><input class="fc" id="prLn" value="${CU.ln}"></div>
    </div>
    <div class="fg"><label class="fl">Email</label><input class="fc" id="prEm" value="${CU.email}"></div>
    <hr class="sep"><div class="fw7" style="margin-bottom:9px">Zmiana has≈Ça</div>
    <div class="fg"><label class="fl">Nowe has≈Ço (puste = bez zmian)</label><input class="fc" type="password" id="prPw"></div>
  </div><div class="mft"><button class="btn btn-sc" onclick="closeM()">Anuluj</button>
    <button class="btn btn-pr" onclick="saveProfile()"><i class="fas fa-save"></i> Zapisz</button></div></div></div>`);
}
function saveProfile(){
  const fn=g('prFn'),ln=g('prLn'),em=g('prEm'),pw=g('prPw');
  const u=DB.users.find(x=>x.id===CU.id);
  u.fn=fn;u.ln=ln;u.email=em;
  if(pw&&pw.length>=6)u.pw=pw;else if(pw){setAl('profA','Has≈Ço min. 6 znak√≥w.');return;}
  CU=u;saveDB();updateTopbar();toast('Profil zaktualizowany.');closeM();
}
function changePw(){
  const op=g('opw'),np=g('npw'),cp=g('cpw');
  if(!op||!np||!cp){toast('Wype≈Çnij wszystkie pola.','wrn');return;}
  if(np!==cp){toast('Has≈Ça nie pasujƒÖ.','err');return;}
  if(np.length<6){toast('Min. 6 znak√≥w.','wrn');return;}
  if(op!==CU.pw){toast('Aktualne has≈Ço nieprawid≈Çowe.','err');return;}
  const u=DB.users.find(x=>x.id===CU.id);u.pw=np;CU.pw=np;saveDB();
  toast('Has≈Ço zmienione.');document.getElementById('opw').value='';document.getElementById('npw').value='';document.getElementById('cpw').value='';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function init(){
  loadTheme();
  if(checkSess())startApp();
  else document.getElementById('loginPg').style.display='flex';
})();
</script>
</body>
</html>